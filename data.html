<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Data DTSEN | TKSK & Puskesos Sumber</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<header class="container py-3">
    <div class="row align-items-center text-center">
        <div class="col-md-4 text-left">
            <img src="assets/img/logo/logo-tksk.png" alt="Logo" height="50">
            <img src="assets/img/logo/logo-puskesos.png" alt="Logo" height="50" class="ml-2">
        </div>
        <div class="col-md-4">
            <h3 class="mb-0 font-weight-bold">DARI DATA KE AKSI</h3>
            <small>Kecamatan Sumber</small>
        </div>
    </div>
</header>

<div id="navbar"></div>

<main class="container py-4">
    <h2>Data DTSEN Kecamatan Sumber</h2>
    <p class="text-muted">Ringkasan data kesejahteraan berbasis wilayah.</p>
    <hr>

    <h4 class="mt-4">Distribusi DTSEN Kecamatan (Agregasi)</h4>
    <div class="table-responsive col-md-6 px-0">
        <table class="table table-bordered table-sm text-center">
            <thead class="thead-light">
                <tr>
                    <th>Kategori Desil</th>
                    <th>Total KK</th>
                </tr>
            </thead>
            <tbody id="tabelDesilKecamatan">
                </tbody>
        </table>
    </div>

    <div class="form-group col-md-4 px-0 mt-5">
        <label><strong>Pilih Desa / Kelurahan</strong></label>
        <select id="wilayahSelect" class="form-control"></select>
    </div>

    <div class="row text-center mb-4">
        <div class="col-md-2 mb-2">
            <div class="card shadow-sm"><div class="card-body p-2"><h4 id="totalKK">—</h4><small>Total KK</small></div></div>
        </div>
        <div class="col-md-2 mb-2">
            <div class="card shadow-sm border-danger"><div class="card-body p-2"><h4 id="desil1">—</h4><small>Desil 1</small></div></div>
        </div>
        <div class="col-md-2 mb-2">
            <div class="card shadow-sm border-warning"><div class="card-body p-2"><h4 id="desil2">—</h4><small>Desil 2</small></div></div>
        </div>
        <div class="col-md-2 mb-2">
            <div class="card shadow-sm"><div class="card-body p-2"><h4 id="desil3">—</h4><small>Desil 3</small></div></div>
        </div>
        <div class="col-md-2 mb-2">
            <div class="card shadow-sm"><div class="card-body p-2"><h4 id="desil4">—</h4><small>Desil 4</small></div></div>
        </div>
        <div class="col-md-2 mb-2">
            <div class="card shadow-sm border-success"><div class="card-body p-2"><h4 id="desil510">—</h4><small>Desil 6-10</small></div></div>
        </div>
    </div>

    <div style="height: 300px; position: relative;">
        <canvas id="desilChart"></canvas>
    </div>
    
    <p class="mt-3 small text-muted">Pembaruan data: <span id="updateData">-</span></p>
</main>

<footer class="py-4 text-center border-top">
    <small>© TKSK Sumber & Forum Puskesos Kecamatan Sumber</small>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let chart;

// 1. Muat Navbar
fetch('navbar.html')
    .then(r => r.text())
    .then(html => {
        document.getElementById('navbar').innerHTML = html;
        const currentPage = location.pathname.split('/').pop() || 'index.html';
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });
    });

// 2. Muat Data JSON
fetch('data/dtsen.json')
    .then(res => res.json())
    .then(data => {
        const select = document.getElementById('wilayahSelect');
        document.getElementById('updateData').innerText = data.updated;

        // A. Proses Tabel Agregasi Kecamatan
        const tabelKec = document.getElementById('tabelDesilKecamatan');
        let agregat = Array(10).fill(0);
        data.wilayah.forEach(w => {
            w.desil.forEach((val, i) => { agregat[i] += val; });
        });

        let rowHtml = "";
        for(let i=0; i<5; i++) {
            rowHtml += `<tr><td>Desil ${i+1}</td><td>${agregat[i].toLocaleString('id-ID')}</td></tr>`;
        }
        let gabungD610Kec = agregat.slice(5).reduce((a, b) => a + b, 0);
        rowHtml += `<tr class="table-success font-weight-bold"><td>Desil 6-10</td><td>${gabungD610Kec.toLocaleString('id-ID')}</td></tr>`;
        tabelKec.innerHTML = rowHtml;

        // B. Inisialisasi Dropdown
        data.wilayah.forEach((w, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = w.nama;
            select.appendChild(opt);
        });

        // C. Event Listener & Render Awal
        select.addEventListener('change', e => renderWilayah(e.target.value, data));
        renderWilayah(0, data);
    })
    .catch(err => console.error("Gagal memuat data:", err));

// 3. Fungsi Render Detail Wilayah
function renderWilayah(idx, data) {
    localStorage.setItem('lastSelectedWilayah', idx);
    const w = data.wilayah[idx];
    const d = w.desil;
    const totalKK = w.total_kk;

    // Fungsi pembantu untuk menghitung persentase secara otomatis
    // Rumus: (Nilai Desil / Total KK) * 100
    const hitungPersen = (nilai) => {
        return totalKK > 0 ? ((nilai / totalKK) * 100).toFixed(1) : 0;
    };

    // Update Label Card dengan angka yang sudah dihitung ke persen
    document.getElementById('totalKK').innerText = totalKK.toLocaleString('id-ID');
    document.getElementById('desil1').innerText = hitungPersen(d[0]) + '%';
    document.getElementById('desil2').innerText = hitungPersen(d[1]) + '%';
    document.getElementById('desil3').innerText = hitungPersen(d[2]) + '%';
    document.getElementById('desil4').innerText = hitungPersen(d[3]) + '%'; // Nama fungsi sudah diperbaiki di sini
    
    // Gabungkan D6 sampai D10 (hitung jumlah riilnya dulu)
    const jumlah610 = d.slice(5).reduce((a, b) => a + b, 0);
    document.getElementById('desil510').innerText = hitungPersen(jumlah610) + '%';

    // Update Grafik (Chart)
    const ctx = document.getElementById('desilChart').getContext('2d');
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['D1', 'D2', 'D3', 'D4', 'D5', 'D6-10'],
            datasets: [{
                label: 'Proporsi (%)',
                // Data diubah menjadi persen sebelum dimasukkan ke chart
                data: [
                    hitungPersen(d[0]), 
                    hitungPersen(d[1]), 
                    hitungPersen(d[2]), 
                    hitungPersen(d[3]), 
                    hitungPersen(d[4]), 
                    hitungPersen(jumlah610)
                ],
                backgroundColor: ['#dc3545', '#ffc107', '#0d6efd', '#6610f2', '#fd7e14', '#28a745']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { 
                y: { 
                    beginAtZero: true, 
                    max: 100, // Mengunci agar maksimal grafik adalah 100%
                    ticks: { callback: v => v + '%' } 
                } 
            },
            plugins: { legend: { display: false } }
        }
    });
}
</script>
</body>
</html>
