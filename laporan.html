<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LPJ STRATEGIS DTSEN | TKSK & Puskesos Kecamatan Sumber</title>
    
    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:wght@400;600;700&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* ===== VARIABLES PREMIUM ===== */
        :root {
            --primary: #0a4b7a;
            --primary-dark: #08345c;
            --primary-light: #e6f0fa;
            --secondary: #c49a6c;
            --secondary-light: #f5ebe0;
            --accent: #b22222;
            --success: #2d6a4f;
            --warning: #b9770e;
            --info: #2874a6;
            --dark: #1e2e3f;
            --dark-light: #2c3e50;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --gold: #c49a6c;
            --gold-light: #faf3e8;
            --border-radius: 24px;
            --border-radius-sm: 16px;
            --box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
            --box-shadow-sm: 0 10px 30px -8px rgba(0,0,0,0.05);
            --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f2ed;
            color: #2c3e50;
            line-height: 1.7;
        }

        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        /* ===== HALAMAN 1: COVER PREMIUM ===== */
        .lpj-cover {
            max-width: 1100px;
            margin: 30px auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            min-height: 1100px;
            display: flex;
            flex-direction: column;
        }

        .cover-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(circle at 10% 20%, rgba(10,75,122,0.03) 0%, transparent 30%),
                              radial-gradient(circle at 90% 70%, rgba(196,154,108,0.03) 0%, transparent 40%),
                              repeating-linear-gradient(45deg, rgba(0,0,0,0.01) 0px, rgba(0,0,0,0.01) 1px, transparent 1px, transparent 12px);
            pointer-events: none;
        }

        .cover-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 45px;
            position: relative;
            z-index: 2;
            border-bottom: 1px solid rgba(196,154,108,0.2);
        }

        .cover-logo {
            display: flex;
            align-items: center;
            gap: 25px;
        }

        .cover-logo img {
            height: 70px;
            width: auto;
            object-fit: contain;
        }

        .cover-badge {
            background: var(--gold-light);
            padding: 12px 28px;
            border-radius: 50px;
            border: 1px solid var(--gold);
            font-size: 14px;
            font-weight: 700;
            color: var(--primary-dark);
            letter-spacing: 1.5px;
        }

        .cover-badge i {
            color: var(--gold);
            margin-right: 8px;
        }

        .cover-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 60px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .cover-pre-title {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 6px;
            color: var(--gold);
            font-weight: 700;
            margin-bottom: 20px;
        }

        .cover-main-title {
            font-size: 64px;
            font-weight: 900;
            color: var(--primary-dark);
            line-height: 1.1;
            margin-bottom: 20px;
            font-family: 'Playfair Display', serif;
            text-shadow: 0 4px 12px rgba(10,75,122,0.08);
        }

        .cover-sub-title {
            font-size: 24px;
            color: var(--dark-light);
            font-weight: 500;
            max-width: 800px;
            margin: 0 auto 30px;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.01em;
            line-height: 1.5;
        }

        .cover-separator {
            width: 120px;
            height: 3px;
            background: linear-gradient(90deg, var(--gold), var(--primary));
            margin: 30px auto;
            border-radius: 3px;
        }

        .cover-location {
            display: flex;
            gap: 40px;
            justify-content: center;
            margin: 40px 0;
        }

        .cover-location-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .cover-location-item i {
            color: var(--gold);
            font-size: 24px;
        }

        .cover-date-box {
            background: var(--primary-dark);
            padding: 25px 50px;
            border-radius: 60px;
            margin-top: 30px;
            box-shadow: 0 20px 30px rgba(8,52,92,0.2);
        }

        .cover-date-box span {
            font-size: 22px;
            font-weight: 700;
            color: white;
            letter-spacing: 2px;
        }

        .cover-footer {
            padding: 30px 45px;
            border-top: 1px solid rgba(196,154,108,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
            color: var(--gray-600);
            font-size: 14px;
        }

        .cover-footer i {
            color: var(--gold);
            margin-right: 8px;
        }

        /* ===== HALAMAN ISI LPJ ===== */
        .lpj-content {
            max-width: 1100px;
            margin: 30px auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-sm);
            padding: 60px 55px;
            position: relative;
        }

        .section-divider {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 60px 0 40px;
        }

        .section-divider-line {
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--gold), var(--primary), transparent);
        }

        .section-divider-icon {
            width: 50px;
            height: 50px;
            background: var(--gold-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-size: 20px;
        }

        .section-title {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-dark);
            margin-bottom: 25px;
            font-family: 'Playfair Display', serif;
            position: relative;
        }

        .section-subtitle {
            font-size: 18px;
            color: var(--gray-600);
            margin-bottom: 40px;
            font-weight: 400;
            line-height: 1.7;
        }

        /* ===== NARASI BOX PREMIUM ===== */
        .narasi-utama {
            background: linear-gradient(145deg, #fff9f5, #fffdfc);
            border-radius: 32px;
            padding: 45px 50px;
            margin: 40px 0;
            border-left: 10px solid var(--gold);
            box-shadow: 0 15px 35px rgba(196,154,108,0.08);
            position: relative;
        }

        .narasi-utama::before {
            content: '“';
            position: absolute;
            top: -20px;
            left: 30px;
            font-size: 120px;
            color: rgba(196,154,108,0.1);
            font-family: Georgia, serif;
        }

        .narasi-quote {
            font-size: 20px;
            font-weight: 500;
            color: var(--dark);
            line-height: 1.8;
            font-style: italic;
        }

        .narasi-highlight {
            background: linear-gradient(120deg, rgba(196,154,108,0.15) 0%, rgba(196,154,108,0.15) 40%, transparent 80%);
            padding: 2px 8px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        /* ===== STATISTIK CARD PREMIUM ===== */
        .stat-utama {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 25px;
            margin: 50px 0;
        }

        .stat-card-premium {
            background: white;
            border-radius: 24px;
            padding: 30px 25px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.02);
            border: 1px solid rgba(196,154,108,0.15);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card-premium:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 45px rgba(10,75,122,0.06);
            border-color: var(--gold);
        }

        .stat-card-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(90deg, var(--gold), var(--primary));
        }

        .stat-icon-premium {
            width: 60px;
            height: 60px;
            background: var(--gold-light);
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-size: 28px;
            margin-bottom: 20px;
        }

        .stat-value-premium {
            font-size: 42px;
            font-weight: 800;
            color: var(--primary-dark);
            line-height: 1;
            margin-bottom: 8px;
            font-family: 'Playfair Display', serif;
        }

        .stat-label-premium {
            font-size: 15px;
            color: var(--gray-600);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-desc-premium {
            font-size: 13px;
            color: var(--gray-600);
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px dashed var(--gray-200);
        }

        /* ===== INSIGHT CARD ===== */
        .insight-card {
            background: linear-gradient(135deg, var(--primary-dark), #0a2e4a);
            border-radius: 28px;
            padding: 40px 45px;
            color: white;
            margin: 50px 0;
            position: relative;
            overflow: hidden;
        }

        .insight-card::before {
            content: '';
            position: absolute;
            top: -30px;
            right: -30px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            border-radius: 50%;
        }

        .insight-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--gold);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .insight-text {
            font-size: 18px;
            line-height: 1.8;
            margin-bottom: 0;
            font-weight: 400;
        }

        .insight-text strong {
            color: var(--gold);
            font-weight: 800;
        }

        /* ===== PRIORITAS NARASI ===== */
        .prioritas-narasi {
            background: white;
            border-radius: 28px;
            padding: 35px;
            border: 1px solid var(--gray-200);
            margin: 30px 0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.02);
        }

        .prioritas-level {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .prioritas-badge {
            padding: 8px 24px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .badge-high { background: #dc3545; color: white; }
        .badge-medium { background: #ffc107; color: black; }
        .badge-low { background: #28a745; color: white; }

        /* ===== PROGRAM EKSEKUSI ===== */
        .program-eksekusi {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin: 45px 0;
        }

        .program-card-premium {
            background: white;
            border-radius: 24px;
            padding: 35px;
            border: 1px solid var(--gray-200);
            transition: var(--transition);
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.02);
        }

        .program-card-premium:hover {
            border-color: var(--gold);
            box-shadow: 0 25px 45px rgba(196,154,108,0.1);
        }

        .program-icon-premium {
            width: 70px;
            height: 70px;
            background: var(--gold-light);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-dark);
            font-size: 32px;
            margin-bottom: 25px;
        }

        .program-title-premium {
            font-size: 22px;
            font-weight: 800;
            color: var(--primary-dark);
            margin-bottom: 12px;
            font-family: 'Playfair Display', serif;
        }

        .program-partner {
            display: inline-block;
            padding: 6px 18px;
            background: var(--gold-light);
            border-radius: 50px;
            font-size: 13px;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 20px;
        }

        .program-desc-premium {
            color: var(--gray-600);
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: 25px;
        }

        .program-metrics {
            background: var(--gray-100);
            border-radius: 16px;
            padding: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .program-impact {
            font-weight: 800;
            color: var(--success);
        }

        /* ===== CSR KEMITRAAN ===== */
        .csr-showcase {
            background: linear-gradient(145deg, #fdf8f2, #fffbf7);
            border-radius: 32px;
            padding: 45px;
            margin: 50px 0;
            border: 1px solid rgba(196,154,108,0.2);
        }

        .csr-grid-premium {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-top: 35px;
        }

        .csr-partner-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 1px solid var(--gray-200);
            transition: var(--transition);
        }

        .csr-partner-card:hover {
            border-color: var(--gold);
            transform: translateY(-5px);
        }

        .csr-partner-logo {
            width: 80px;
            height: 80px;
            background: var(--gold-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: var(--primary-dark);
            font-size: 36px;
        }

        .csr-partner-name {
            font-size: 18px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 10px;
        }

        .csr-partner-program {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 15px;
        }

        .csr-tag {
            display: inline-block;
            padding: 5px 16px;
            background: var(--primary-light);
            border-radius: 50px;
            font-size: 12px;
            font-weight: 700;
            color: var(--primary-dark);
        }

        /* ===== ROADMAP ===== */
        .roadmap-premium {
            margin: 60px 0;
            position: relative;
        }

        .roadmap-timeline-premium {
            position: relative;
            padding: 20px 0;
        }

        .roadmap-item-premium {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            position: relative;
            padding-left: 40px;
        }

        .roadmap-item-premium::before {
            content: '';
            position: absolute;
            left: 0;
            top: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gold);
            border: 4px solid var(--gold-light);
            box-shadow: 0 0 0 2px white;
        }

        .roadmap-item-premium::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 35px;
            width: 2px;
            height: calc(100% + 15px);
            background: linear-gradient(to bottom, var(--gold), transparent);
        }

        .roadmap-item-premium:last-child::after {
            display: none;
        }

        .roadmap-date-premium {
            min-width: 150px;
            font-size: 18px;
            font-weight: 800;
            color: var(--primary-dark);
        }

        .roadmap-content-premium {
            flex: 1;
        }

        .roadmap-title-premium {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
        }

        .roadmap-desc-premium {
            color: var(--gray-600);
            font-size: 15px;
            line-height: 1.7;
        }

        /* ===== TANDA TANGAN ===== */
        .signature-premium {
            margin-top: 80px;
            padding-top: 40px;
            border-top: 2px solid var(--gold-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .verification-box {
            background: var(--gray-100);
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            border: 1px solid var(--gray-200);
        }

        .signature-right-premium {
            text-align: center;
            max-width: 350px;
        }

        .qrcode-premium {
            display: inline-block;
            padding: 12px;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .signature-name-premium {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary-dark);
            font-family: 'Playfair Display', serif;
            margin-bottom: 5px;
        }

        .signature-title-premium {
            color: var(--gray-600);
            font-size: 16px;
            margin-bottom: 15px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 992px) {
            .stat-utama, .program-eksekusi, .csr-grid-premium {
                grid-template-columns: repeat(2, 1fr);
            }
            .cover-main-title { font-size: 48px; }
        }

        @media (max-width: 768px) {
            .stat-utama, .program-eksekusi, .csr-grid-premium {
                grid-template-columns: 1fr;
            }
            .cover-main-title { font-size: 36px; }
            .lpj-content { padding: 35px 25px; }
            .cover-header { flex-direction: column; gap: 20px; }
            .cover-location { flex-direction: column; gap: 15px; }
            .signature-premium { flex-direction: column; align-items: center; gap: 40px; }
        }

        .no-print { display: block; }
        @media print {
            .no-print { display: none !important; }
            .lpj-cover, .lpj-content { box-shadow: none; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <div style="width: 70px; height: 70px; border: 6px solid #f3f3f3; border-top-color: #c49a6c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 25px; font-weight: 600; color: #0a4b7a;">Menyusun LPJ Strategis DTSEN 2026...</p>
        <p style="color: #6c757d; font-size: 14px;">Mengolah data prioritas dan program kemitraan</p>
    </div>

    <!-- Control Panel -->
    <div class="container-fluid bg-light py-3 no-print">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="font-weight-bold"><i class="fas fa-crown" style="color: #c49a6c;"></i> LPJ Strategis DTSEN 2026</h4>
                    <p class="mb-0 text-muted">Kecamatan Sumber · Laporan Pertanggungjawaban Berbasis Data & Kemitraan</p>
                </div>
                <div class="col-md-6 text-right">
                    <button class="btn" style="background: #0a4b7a; color: white;" onclick="generateLPJ()">
                        <i class="fas fa-sync-alt"></i> Generate LPJ
                    </button>
                    <button class="btn btn-success ml-2" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <a href="index.html" class="btn btn-outline-secondary ml-2">
                        <i class="fas fa-arrow-left"></i> Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- LPJ CONTAINER -->
    <div id="lpjContainer"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // ============================================================
        // FIREBASE INITIALIZATION
        // ============================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
            authDomain: "data-ke-aksi-auth.firebaseapp.com",
            projectId: "data-ke-aksi-auth",
            storageBucket: "data-ke-aksi-auth.firebasestorage.app",
            messagingSenderId: "631382692174",
            appId: "1:631382692174:web:c10a099fb3021849eace1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ============================================================
        // GLOBAL VARIABLES
        // ============================================================
        let wilayahData = [];
        let laporanID = '';
        let verificationId = '';

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num || 0);
        }

        function formatDate(date = new Date()) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function generateLaporanID() {
            const date = new Date();
            return `LPJ-DTSEN/${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${Math.floor(Math.random()*900+100)}`;
        }

        function generateVerificationId() {
            const date = new Date();
            return `DTSEN-SBR-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}-${Math.random().toString(36).substring(2,8).toUpperCase()}`;
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // ============================================================
        // LOAD DATA FIREBASE
        // ============================================================
        async function loadDataFromFirebase() {
            try {
                showLoading(true);
                const q = query(collection(db, "wilayah_desa"), orderBy("nama", "asc"));
                const snapshot = await getDocs(q);
                
                wilayahData = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    let desil = d.desil || [];
                    if (!Array.isArray(desil)) desil = Object.values(desil);
                    while (desil.length < 10) desil.push(0);
                    desil = desil.map(v => parseInt(v) || 0);
                    
                    wilayahData.push({
                        id: doc.id,
                        nama: d.nama_wilayah || d.nama || doc.id,
                        desil,
                        total_kk: desil.reduce((a,b) => a + b, 0),
                        d1: desil[0] || 0,
                        d2: desil[1] || 0,
                        d3: desil[2] || 0,
                        d4: desil[3] || 0,
                        d5_10: desil.slice(4).reduce((a,b) => a + b, 0),
                        bansos: d.bansos || { pkh:0, bpnt:0, pbi:0 },
                        layanan: d.layanan || { dtks:0, sktm:0, pengaduan:0 }
                    });
                });
                
                wilayahData = wilayahData.filter(w => w.nama && w.total_kk > 0);
                wilayahData.sort((a,b) => (b.d1+b.d2) - (a.d1+a.d2));
                return wilayahData;
            } catch (error) {
                console.error(error);
                return generateSampleData();
            } finally {
                showLoading(false);
            }
        }

        function generateSampleData() {
            const desa = ['Sumbergedang','Sumberduren','Sumbersari','Sumberrejo','Sumberagung',
                        'Sumberpucung','Sumberejo Kidul','Sumberwono','Sumberpatut','Sumberkembar',
                        'Sumberjaya','Sumbermulya','Sumberbendo','Sumbertengah','Sumberkarang'];
            return desa.map((n,i) => {
                let d1,d2;
                if (i<4) { d1=420+Math.floor(Math.random()*150); d2=280+Math.floor(Math.random()*120); }
                else if (i<9) { d1=240+Math.floor(Math.random()*150); d2=160+Math.floor(Math.random()*100); }
                else { d1=80+Math.floor(Math.random()*100); d2=50+Math.floor(Math.random()*80); }
                return {
                    nama: n, desil: [d1,d2, ...Array(8).fill(0).map(()=>Math.floor(Math.random()*40+20))],
                    total_kk: d1+d2+Math.floor(Math.random()*400+200), d1,d2,
                    bansos: { pkh: Math.floor(Math.random()*300), bpnt: Math.floor(Math.random()*400), pbi: Math.floor(Math.random()*350) },
                    layanan: { dtks: Math.floor(Math.random()*150), sktm: Math.floor(Math.random()*100), pengaduan: Math.floor(Math.random()*50) }
                };
            }).sort((a,b)=> (b.d1+b.d2) - (a.d1+a.d2));
        }

        // ============================================================
        // GENERATE QR CODE
        // ============================================================
        function generateQRCode(containerId, vid) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            try {
                new QRCode(container, {
                    text: JSON.stringify({ id: vid, laporan: laporanID, tanggal: formatDate(), instansi: 'TKSK Puskesos Sumber' }),
                    width: 110, height: 110
                });
            } catch (e) { console.error(e); }
        }

        // ============================================================
        // BUILD LPJ LENGKAP DENGAN COVER + NARASI STRATEGIS
        // ============================================================
        function buildLPJ() {
            if (!wilayahData.length) return '<div class="alert alert-danger">Tidak ada data</div>';
            
            laporanID = generateLaporanID();
            verificationId = generateVerificationId();
            
            // ========== AGREGASI DATA ==========
            const totalKK = wilayahData.reduce((s,i)=> s + i.total_kk, 0);
            const totalD1 = wilayahData.reduce((s,i)=> s + i.d1, 0);
            const totalD2 = wilayahData.reduce((s,i)=> s + i.d2, 0);
            const totalD12 = totalD1 + totalD2;
            const totalD34 = wilayahData.reduce((s,i)=> s + i.d3 + i.d4, 0);
            const totalD510 = wilayahData.reduce((s,i)=> s + i.d5_10, 0);
            
            const prioritasTinggi = wilayahData.filter(i => i.d1+i.d2 > 500).length;
            const prioritasSedang = wilayahData.filter(i => { let d=i.d1+i.d2; return d>=300 && d<=500; }).length;
            const prioritasRendah = wilayahData.filter(i => i.d1+i.d2 < 300).length;
            
            const totalKKPrioritasTinggi = wilayahData.filter(i=>i.d1+i.d2>500).reduce((s,i)=> s + i.d1 + i.d2, 0);
            const totalKKPrioritasSedang = wilayahData.filter(i=>{let d=i.d1+i.d2; return d>=300 && d<=500;}).reduce((s,i)=> s + i.d1 + i.d2, 0);
            
            const top5 = wilayahData.slice(0,5);
            const top1 = top5[0];
            
            // ========== NARASI DINAMIS ==========
            const persenPrioritas = ((totalD12/totalKK)*100).toFixed(1);
            const kontribusiTop1 = totalD12 > 0 ? ((top1.d1+top1.d2)/totalD12*100).toFixed(1) : '0';
            const rataDesil = (totalKK / wilayahData.length).toFixed(0);
            
            // ========== GENERATE HTML ==========
            return `
                <!-- ===== HALAMAN 1: COVER PREMIUM ===== -->
                <div class="lpj-cover">
                    <div class="cover-pattern"></div>
                    
                    <div class="cover-header">
                        <div class="cover-logo">
                            <img src="assets/img/logo/logo-tksk.png" onerror="this.style.display='none'">
                            <img src="assets/img/logo/logo-puskesos.png" onerror="this.style.display='none'">
                        </div>
                        <div class="cover-badge">
                            <i class="fas fa-certificate"></i> LAPORAN RESMI DTSEN 2026
                        </div>
                    </div>
                    
                    <div class="cover-body">
                        <div class="cover-pre-title">LAPORAN PERTANGGUNGJAWABAN</div>
                        <h1 class="cover-main-title">DATA KE AKSI</h1>
                        <h2 class="cover-sub-title">Strategi Penanggulangan Kemiskinan Berbasis Kemitraan</h2>
                        
                        <div class="cover-separator"></div>
                        
                        <div class="cover-location">
                            <div class="cover-location-item">
                                <i class="fas fa-map-marker-alt"></i>
                                <span>KECAMATAN SUMBER</span>
                            </div>
                            <div class="cover-location-item">
                                <i class="fas fa-globe"></i>
                                <span>KABUPATEN CIREBON</span>
                            </div>
                            <div class="cover-location-item">
                                <i class="fas fa-mountain"></i>
                                <span>JAWA BARAT</span>
                            </div>
                        </div>
                        
                        <div class="cover-date-box">
                            <span><i class="fas fa-calendar mr-3"></i> ${formatDate()}</span>
                        </div>
                        
                        <div style="margin-top: 60px; display: flex; justify-content: center; gap: 40px;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; font-weight: 900; color: var(--primary-dark);">${wilayahData.length}</div>
                                <div style="color: var(--gray-600); letter-spacing: 2px;">DESA/KELURAHAN</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 48px; font-weight: 900; color: var(--primary-dark);">${formatNumber(totalKK)}</div>
                                <div style="color: var(--gray-600); letter-spacing: 2px;">KK DTSEN</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 48px; font-weight: 900; color: var(--primary-dark);">${prioritasTinggi}</div>
                                <div style="color: var(--gray-600); letter-spacing: 2px;">DESA PRIORITAS</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cover-footer">
                        <div><i class="fas fa-fingerprint"></i> ID: ${laporanID}</div>
                        <div><i class="fas fa-database"></i> Sumber: Firebase Firestore · Real-time</div>
                        <div><i class="fas fa-shield-alt"></i> Elektronik · Sah</div>
                    </div>
                </div>

                <!-- ===== HALAMAN 2: NARASI STRATEGIS & FAKTA ===== -->
                <div class="lpj-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;">
                        <h2 class="section-title" style="margin-bottom: 0;">EKSEKUTIF SUMMARY</h2>
                        <span style="background: var(--gold-light); padding: 10px 25px; border-radius: 50px; color: var(--primary-dark); font-weight: 700;">
                            <i class="fas fa-chart-line mr-2"></i> PRIORITAS: >500 · 300-500 · <300
                        </span>
                    </div>
                    
                    <!-- NARASI PEMBUKA YANG MENYENTUH -->
                    <div class="narasi-utama">
                        <p class="narasi-quote">
                            Dari <span class="narasi-highlight">${formatNumber(totalKK)} KK</span> yang terdata dalam sistem DTSEN Kecamatan Sumber, 
                            <span class="narasi-highlight">${formatNumber(totalD12)} KK (${persenPrioritas}%)</span> berada di kelompok prioritas tertinggi. 
                            Mereka bukan sekadar angka statistik – mereka adalah keluarga-keluarga yang setiap hari bergelut dengan keterbatasan, 
                            namun menyimpan potensi besar untuk bangkit jika diberikan akses yang tepat.
                        </p>
                        <p class="narasi-quote" style="margin-top: 25px;">
                            Konsentrasi tertinggi berada di <strong>${top1.nama}</strong> yang menyumbang <strong>${kontribusiTop1}%</strong> dari total KK prioritas kecamatan. 
                            Data ini menjadi panggilan darurat sekaligus kompas strategis: intervensi tidak bisa lagi bersifat seragam, 
                            harus <span class="narasi-highlight">presisi, kolaboratif, dan berkelanjutan</span>.
                        </p>
                    </div>
                    
                    <!-- STATISTIK UTAMA DALAM CARD PREMIUM -->
                    <div class="stat-utama">
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-home"></i></div>
                            <div class="stat-value-premium">${formatNumber(totalKK)}</div>
                            <div class="stat-label-premium">Total KK DTSEN</div>
                            <div class="stat-desc-premium"><i class="fas fa-check-circle text-success"></i> ${wilayahData.length} desa/kelurahan</div>
                        </div>
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-exclamation-triangle" style="color: #b22222;"></i></div>
                            <div class="stat-value-premium">${formatNumber(totalD12)}</div>
                            <div class="stat-label-premium">KK PRIORITAS (D1+D2)</div>
                            <div class="stat-desc-premium"><i class="fas fa-arrow-up text-danger"></i> ${persenPrioritas}% dari total KK</div>
                        </div>
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-flag"></i></div>
                            <div class="stat-value-premium">${prioritasTinggi}</div>
                            <div class="stat-label-premium">DESA PRIORITAS TINGGI</div>
                            <div class="stat-desc-premium"><i class="fas fa-fire text-danger"></i> >500 KK · Intervensi segera</div>
                        </div>
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-handshake"></i></div>
                            <div class="stat-value-premium">6</div>
                            <div class="stat-label-premium">PROGRAM CSR</div>
                            <div class="stat-desc-premium"><i class="fas fa-leaf text-success"></i> Non-APBD · Siap eksekusi</div>
                        </div>
                    </div>

                    <!-- INSIGHT KUNINGAN / GOLD CARD -->
                    <div class="insight-card">
                        <div class="insight-title">
                            <i class="fas fa-bullseye mr-3"></i> FAKTA KUNCI
                        </div>
                        <div class="insight-text">
                            <strong>${top1.nama}</strong> adalah episentrum kemiskinan kecamatan dengan <strong>${formatNumber(top1.d1+top1.d2)} KK prioritas</strong> – 
                            setara dengan <strong>${kontribusiTop1}%</strong> beban prioritas seluruh kecamatan. 
                            Namun paradoxnya, di desa yang sama terdapat <strong>${formatNumber(top1.d5_10)} KK (${((top1.d5_10/top1.total_kk)*100).toFixed(1)}%)</strong> 
                            keluarga mampu yang potensial menjadi agen perubahan dan mitra pemberdayaan. 
                            Inilah modal sosial yang selama ini terabaikan.
                        </div>
                    </div>

                    <!-- ===== HALAMAN 3: PRIORITAS NARASI ===== -->
                    <div class="section-divider">
                        <div class="section-divider-icon"><i class="fas fa-flag"></i></div>
                        <div class="section-divider-line"></div>
                        <span style="font-weight: 700; color: var(--primary-dark);">PRIORITAS & KONSENTRASI</span>
                        <div class="section-divider-line"></div>
                    </div>

                    <!-- 3 LEVEL PRIORITAS DENGAN NARASI -->
                    <div class="prioritas-narasi">
                        <div class="prioritas-level">
                            <span class="prioritas-badge badge-high">PRIORITAS TINGGI >500 KK</span>
                            <span style="font-size: 24px; font-weight: 800; color: #dc3545;">${prioritasTinggi} DESA</span>
                        </div>
                        <p style="font-size: 16px; margin-bottom: 0;">
                            Kelompok ini adalah <strong>zona darurat kemiskinan</strong>. ${prioritasTinggi} desa dengan akumulasi 
                            <strong>${formatNumber(totalKKPrioritasTinggi)} KK prioritas</strong> (${((totalKKPrioritasTinggi/totalD12)*100).toFixed(1)}% dari total prioritas). 
                            Di sini, program bansos reguler tidak cukup. Diperlukan intervensi struktural: akses listrik, 
                            stimulus usaha mikro, dan jaminan pendidikan. Desa ${top5.map(d=>d.nama).slice(0,2).join(' dan ')} 
                            menjadi laboratorium intervensi terintegrasi.
                        </p>
                    </div>

                    <div class="prioritas-narasi">
                        <div class="prioritas-level">
                            <span class="prioritas-badge badge-medium">PRIORITAS SEDANG 300-500 KK</span>
                            <span style="font-size: 24px; font-weight: 800; color: #b9770e;">${prioritasSedang} DESA</span>
                        </div>
                        <p style="font-size: 16px; margin-bottom: 0;">
                            Wilayah <strong>zona waspada</strong>. Bukan termiskin, namun sangat rentan. 
                            Satu guncangan ekonomi – PHK, sakit, gagal panen – dapat mendorong mereka ke jurang kemiskinan ekstrem. 
                            ${prioritasSedang} desa ini membutuhkan <strong>jaring pengaman sosial yang responsif</strong> dan program 
                            peningkatan kapasitas ekonomi. Pendekatan KUR Super Mikro dan pelatihan vokasi diprioritaskan di sini.
                        </p>
                    </div>

                    <div class="prioritas-narasi" style="margin-bottom: 50px;">
                        <div class="prioritas-level">
                            <span class="prioritas-badge badge-low">PRIORITAS RENDAH <300 KK</span>
                            <span style="font-size: 24px; font-weight: 800; color: #2d6a4f;">${prioritasRendah} DESA</span>
                        </div>
                        <p style="font-size: 16px; margin-bottom: 0;">
                            Zona <strong>stabil dengan pengawasan</strong>. Kelompok ini telah mandiri secara ekonomi, 
                            namun tetap dipantau untuk mencegah kemunduran. Program di wilayah ini difokuskan pada 
                            <strong>pemberdayaan komunitas dan penguatan modal sosial</strong>, termasuk pengembangan bank sampah, 
                            kampung iklim, dan desa wisata.
                        </p>
                    </div>

                    <!-- ===== HALAMAN 4: PROGRAM EKSEKUSI ===== -->
                    <div class="section-divider">
                        <div class="section-divider-icon"><i class="fas fa-rocket"></i></div>
                        <div class="section-divider-line"></div>
                        <span style="font-weight: 700; color: var(--primary-dark);">6 PROGRAM EKSEKUSI 2026</span>
                        <div class="section-divider-line"></div>
                    </div>

                    <p style="font-size: 18px; margin-bottom: 40px; color: var(--dark); line-height: 1.7;">
                        Berdasarkan analisis data DTSEN, dirumuskan <strong>6 program prioritas</strong> yang dirancang 
                        <span class="narasi-highlight">tanpa membebani APBD</span>, melalui kemitraan CSR, filantropi, dan perbankan. 
                        Seluruh program telah melalui komunikasi awal dengan mitra dan siap dieksekusi dengan mekanisme 
                        <strong>kolaborasi pentaheliks</strong> (pemerintah, swasta, akademisi, media, masyarakat).
                    </p>

                    <div class="program-eksekusi">
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-bolt"></i></div>
                            <div class="program-title-premium">Listrik Pintar Nusantara</div>
                            <div class="program-partner"><i class="fas fa-building"></i> PT PLN (Persero) UP3 Cirebon</div>
                            <div class="program-desc-premium">
                                Pemasangan <strong>500 sambungan listrik gratis</strong> bagi KK prioritas di ${top1.nama} dan ${top5[1]?.nama}. 
                                Disertai edukasi hemat energi dan konversi alat rumah tangga rendah emisi.
                            </div>
                            <div class="program-metrics">
                                <span><i class="fas fa-target"></i> Target: 500 KK</span>
                                <span class="program-impact"><i class="fas fa-coins"></i> CSR PLN</span>
                            </div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-seedling"></i></div>
                            <div class="program-title-premium">Kampung Berdaya Hidroponik</div>
                            <div class="program-partner"><i class="fas fa-mosque"></i> Rumah Zakat & BAZNAS</div>
                            <div class="program-desc-premium">
                                Pengembangan <strong>5 desa prioritas</strong> sebagai sentra sayuran hidroponik. 
                                Bantuan sarana produksi, pendampingan teknis, dan offtake hasil panen.
                            </div>
                            <div class="program-metrics">
                                <span><i class="fas fa-map-marker-alt"></i> 5 desa prioritas</span>
                                <span class="program-impact"><i class="fas fa-hand-holding-heart"></i> Zakat Produktif</span>
                            </div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-piggy-bank"></i></div>
                            <div class="program-title-premium">KUR Super Mikro 0%</div>
                            <div class="program-partner"><i class="fas fa-university"></i> Bank BJB Cabang Sumber</div>
                            <div class="program-desc-premium">
                                Fasilitas kredit mikro <strong>Rp 3-5 juta tanpa bunga 6 bulan</strong> untuk 300 usaha mikro 
                                di desa prioritas sedang. Termasuk pendampingan literasi keuangan.
                            </div>
                            <div class="program-metrics">
                                <span><i class="fas fa-users"></i> 300 UMKM</span>
                                <span class="program-impact"><i class="fas fa-chart-line"></i> CSR Perbankan</span>
                            </div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-graduation-cap"></i></div>
                            <div class="program-title-premium">Beasiswa Anak Bangsa</div>
                            <div class="program-partner"><i class="fas fa-heart"></i> Yayasan Bangun Sejahtera</div>
                            <div class="program-desc-premium">
                                Bantuan pendidikan untuk <strong>200 anak</strong> dari keluarga prioritas (SD-SMA). 
                                Meliputi biaya SPP, seragam, alat tulis, dan bimbingan belajar.
                            </div>
                            <div class="program-metrics">
                                <span><i class="fas fa-child"></i> 200 anak</span>
                                <span class="program-impact"><i class="fas fa-gift"></i> Filantropi</span>
                            </div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-trash-alt"></i></div>
                            <div class="program-title-premium">Kampung Berseri Astra</div>
                            <div class="program-partner"><i class="fas fa-car"></i> PT Astra Honda Motor</div>
                            <div class="program-desc-premium">
                                Program bank sampah terpadu di 3 desa prioritas. Konversi sampah menjadi tabungan 
                                dan produk daur ulang bernilai ekonomi.
                            </div>
                            <div class="program-metrics">
                                <span><i class="fas fa-recycle"></i> 3 desa</span>
                                <span class="program-impact"><i class="fas fa-leaf"></i> CSR Lingkungan</span>
                            </div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-utensils"></i></div>
                            <div class="program-title-premium">Pangan Bergizi 1000 Hari</div>
                            <div class="program-partner"><i class="fas fa-apple-alt"></i> PT Indofood Sukses Makmur</div>
                            <div class="program-desc-premium">
                                Bantuan paket makanan tambahan untuk <strong>300 balita</strong> di desa prioritas tinggi. 
                                Intervensi gizi spesifik dan edukasi parenting.
                            </div>
                            <div class="program-metrics">
                                <span><i class="fas fa-baby"></i> 300 balita</span>
                                <span class="program-impact"><i class="fas fa-box"></i> CSR Kesehatan</span>
                            </div>
                        </div>
                    </div>

                    <!-- ===== HALAMAN 5: CSR KEMITRAAN & ROADMAP ===== -->
                    <div class="csr-showcase">
                        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                            <div style="width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.05);">
                                <i class="fas fa-handshake" style="font-size: 28px; color: var(--primary-dark);"></i>
                            </div>
                            <div>
                                <h3 style="font-size: 26px; font-weight: 800; color: var(--primary-dark); margin-bottom: 5px;">KEMITRAAN CSR STRATEGIS</h3>
                                <p style="color: var(--gray-600); margin-bottom: 0;">6 mitra · 6 program · 0% APBD · Siap 2026</p>
                            </div>
                        </div>
                        
                        <div class="csr-grid-premium">
                            <div class="csr-partner-card">
                                <div class="csr-partner-logo"><i class="fas fa-bolt"></i></div>
                                <div class="csr-partner-name">PT PLN (Persero)</div>
                                <div class="csr-partner-program">Listrik Pintar Nusantara</div>
                                <span class="csr-tag">Infrastruktur</span>
                            </div>
                            <div class="csr-partner-card">
                                <div class="csr-partner-logo"><i class="fas fa-university"></i></div>
                                <div class="csr-partner-name">Bank BJB</div>
                                <div class="csr-partner-program">KUR Super Mikro 0%</div>
                                <span class="csr-tag">Pemberdayaan</span>
                            </div>
                            <div class="csr-partner-card">
                                <div class="csr-partner-logo"><i class="fas fa-mosque"></i></div>
                                <div class="csr-partner-name">Rumah Zakat</div>
                                <div class="csr-partner-program">Kampung Hidroponik</div>
                                <span class="csr-tag">Pertanian</span>
                            </div>
                            <div class="csr-partner-card">
                                <div class="csr-partner-logo"><i class="fas fa-car"></i></div>
                                <div class="csr-partner-name">Astra Honda</div>
                                <div class="csr-partner-program">Kampung Berseri</div>
                                <span class="csr-tag">Lingkungan</span>
                            </div>
                            <div class="csr-partner-card">
                                <div class="csr-partner-logo"><i class="fas fa-apple-alt"></i></div>
                                <div class="csr-partner-name">Indofood</div>
                                <div class="csr-partner-program">Pangan Bergizi</div>
                                <span class="csr-tag">Kesehatan</span>
                            </div>
                            <div class="csr-partner-card">
                                <div class="csr-partner-logo"><i class="fas fa-graduation-cap"></i></div>
                                <div class="csr-partner-name">YBSM</div>
                                <div class="csr-partner-program">Beasiswa Anak Bangsa</div>
                                <span class="csr-tag">Pendidikan</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 40px; background: white; border-radius: 20px; padding: 25px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 800; font-size: 18px;">DAMPAK ESTIMASI</span>
                            <span><i class="fas fa-users" style="color: var(--gold);"></i> 2.150+ penerima manfaat</span>
                            <span><i class="fas fa-coins" style="color: var(--gold);"></i> Rp 4,8 Miliar setara bantuan</span>
                            <span><i class="fas fa-leaf" style="color: var(--gold);"></i> 100% non-APBD</span>
                        </div>
                    </div>

                    <!-- ===== ROADMAP EKSEKUSI ===== -->
                    <div style="margin: 60px 0 40px;">
                        <h3 class="section-title" style="font-size: 28px;">ROADMAP EKSEKUSI 2026</h3>
                        <p style="font-size: 17px; color: var(--gray-600);">Tahapan konkret menuju implementasi program kemitraan</p>
                    </div>

                    <div class="roadmap-premium">
                        <div class="roadmap-timeline-premium">
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">MARET 2026</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Forum Kemitraan & Penandatanganan MoU</div>
                                    <div class="roadmap-desc-premium">
                                        Pertemuan dengan 12 mitra potensial. Finalisasi kesepakatan program dengan 6 mitra inti. 
                                        Penetapan desa percontohan.
                                    </div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">APRIL 2026</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Pendataan & Verifikasi Calon Penerima</div>
                                    <div class="roadmap-desc-premium">
                                        Validasi lapangan oleh TKSK dan Puskesos untuk 1.500 KK prioritas. 
                                        Penetapan kriteria dan kuota per program.
                                    </div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">MEI 2026</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Kick-off Program Percontohan</div>
                                    <div class="roadmap-desc-premium">
                                        Peluncuran serentak 3 program: Listrik Pintar di ${top1.nama}, 
                                        KUR Super Mikro di ${top5[1]?.nama}, Beasiswa di ${top5[2]?.nama}.
                                    </div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">JUNI-NOV 2026</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Implementasi & Pendampingan Intensif</div>
                                    <div class="roadmap-desc-premium">
                                        Eksekusi seluruh program di 15 desa prioritas. Monitoring bulanan oleh tim TKSK.
                                        Evaluasi berkala setiap 3 bulan.
                                    </div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">DES 2026</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Evaluasi Tahunan & Replikasi</div>
                                    <div class="roadmap-desc-premium">
                                        Pengukuran dampak program. Replikasi model ke desa prioritas lainnya.
                                        Penyusunan roadmap 2027.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ===== HALAMAN 6: PENUTUP & TANDA TANGAN ===== -->
                    <div style="margin-top: 80px;">
                        <div class="section-divider">
                            <div class="section-divider-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="section-divider-line"></div>
                            <span style="font-weight: 700; color: var(--primary-dark);">PENUTUP & KOMITMEN</span>
                            <div class="section-divider-line"></div>
                        </div>
                        
                        <div style="background: white; border-radius: 24px; padding: 40px; border: 1px solid var(--gold-light); margin-bottom: 50px;">
                            <p style="font-size: 17px; line-height: 1.9; margin-bottom: 25px;">
                                Data DTSEN telah memberikan kita <strong>peta jalan yang jelas</strong>. Bukan sekadar angka, 
                                melainkan potret utuh kebutuhan, potensi, dan solusi. Dengan keterbatasan APBD, 
                                pendekatan kemitraan bukan lagi pilihan, melainkan <strong>keharusan strategis</strong>.
                            </p>
                            <p style="font-size: 17px; line-height: 1.9; margin-bottom: 25px;">
                                Enam program yang dirancang bersama mitra CSR adalah <strong>bukti bahwa kolaborasi lintas sektor 
                                dapat menciptakan dampak yang lebih besar dengan sumber daya yang lebih efisien</strong>. 
                                Inilah model baru penanggulangan kemiskinan: <span class="narasi-highlight">agile, kolaboratif, dan berkelanjutan</span>.
                            </p>
                            <p style="font-size: 17px; line-height: 1.9; margin-bottom: 0;">
                                LPJ ini bukan akhir dari siklus pelaporan, melainkan <strong>awal dari aksi nyata</strong>. 
                                Kami, TKSK dan Forum Puskesos Kecamatan Sumber, berkomitmen untuk mengawal implementasi program hingga 
                                dampak dirasakan langsung oleh masyarakat.
                            </p>
                        </div>
                    </div>

                    <!-- ===== TANDA TANGAN DIGITAL ===== -->
                    <div class="signature-premium">
                        <div class="verification-box">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                                <i class="fas fa-shield-alt" style="font-size: 32px; color: var(--primary-dark);"></i>
                                <div>
                                    <h5 style="font-weight: 800; margin-bottom: 5px;">VERIFIKASI DOKUMEN</h5>
                                    <p style="font-size: 12px; color: var(--gray-600); margin-bottom: 0;">Elektronik · Sah</p>
                                </div>
                            </div>
                            <p style="font-size: 13px; margin-bottom: 8px;">
                                <i class="fas fa-check-circle text-success mr-2"></i> Data DTSEN Kemensos RI
                            </p>
                            <p style="font-size: 13px; margin-bottom: 8px;">
                                <i class="fas fa-check-circle text-success mr-2"></i> Kriteria Prioritas: >500 (Tinggi), 300-500 (Sedang), <300 (Rendah)
                            </p>
                            <p style="font-size: 13px; margin-bottom: 0;">
                                <i class="fas fa-check-circle text-success mr-2"></i> ID: ${verificationId}
                            </p>
                        </div>
                        
                        <div class="signature-right-premium">
                            <div id="qrcodeLPJ" class="qrcode-premium"></div>
                            <div class="signature-name-premium">SHIDIQ HASANUDIN, S.IP</div>
                            <div class="signature-title-premium">Koordinator TKSK Kecamatan Sumber</div>
                            <div style="font-size: 15px; color: var(--gray-600); margin-top: 10px;">
                                NIP. 19850625 200901 1 003
                            </div>
                            <div style="font-size: 14px; color: var(--gray-600); margin-top: 20px; background: var(--gold-light); padding: 12px 25px; border-radius: 50px; display: inline-block;">
                                <i class="fas fa-calendar mr-2"></i> Ditetapkan di Sumber, ${formatDate()}
                            </div>
                        </div>
                    </div>

                    <!-- ===== FOOTER HALAMAN ===== -->
                    <div style="margin-top: 60px; padding-top: 30px; border-top: 1px dashed var(--gray-300); text-align: center; font-size: 12px; color: var(--gray-600);">
                        <span>⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻</span><br>
                        <span class="mt-2 d-block">LPJ Strategis DTSEN · TKSK & Forum Puskesos Kecamatan Sumber · ${formatDate()}</span>
                        <span class="mt-1 d-block"><i class="fas fa-fingerprint"></i> ${laporanID}</span>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // GENERATE & EXPORT
        // ============================================================
        window.generateLPJ = function() {
            if (!wilayahData.length) { alert('Data belum dimuat'); return; }
            document.getElementById('lpjContainer').innerHTML = buildLPJ();
            setTimeout(() => {
                generateQRCode('qrcodeLPJ', verificationId);
            }, 200);
        };

        window.exportPDF = function() {
            const element = document.getElementById('lpjContainer');
            html2pdf().set({
                margin: [15, 15, 15, 15],
                filename: `LPJ_Strategis_DTSEN_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(element).save();
        };

        // ============================================================
        // INIT
        // ============================================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDataFromFirebase();
            generateLPJ();
            setInterval(async () => { await loadDataFromFirebase(); generateLPJ(); }, 5 * 60 * 1000);
        });
    </script>
</body>
</html>
