<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laporan Resmi DTSEN - TKSK & Puskesos Kecamatan Sumber</title>
    
    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Print & PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* ===== VARIABLES ===== */
        :root {
            --primary: #0a58ca;
            --primary-dark: #084298;
            --primary-light: #e7f1ff;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --dark: #1a2e3f;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-600: #6c757d;
            --border-radius: 12px;
            --box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Times New Roman', Times, serif;
            background-color: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        /* ===== HALAMAN COVER ===== */
        .page-cover {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 25mm 20mm;
            margin: 20px auto;
            box-shadow: var(--box-shadow);
            position: relative;
            page-break-after: always;
            display: flex;
            flex-direction: column;
        }

        /* ===== HALAMAN ISI ===== */
        .page-content {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 25mm 20mm;
            margin: 20px auto;
            box-shadow: var(--box-shadow);
            position: relative;
            page-break-after: always;
        }

        /* ===== KOP SURAT RESMI ===== */
        .kop-surat {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid #000;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .logo-wrapper {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-wrapper img {
            max-width: 100%;
            max-height: 100px;
            object-fit: contain;
        }

        .kop-text {
            text-align: center;
            flex-grow: 1;
        }

        .instansi {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .lembaga {
            font-size: 20px;
            font-weight: 800;
            margin: 5px 0;
            text-transform: uppercase;
            color: #000;
        }

        .program {
            font-size: 28px;
            font-weight: 900;
            margin: 8px 0;
            letter-spacing: 2px;
            color: var(--primary);
        }

        .alamat {
            font-size: 11px;
            margin: 3px 0;
            color: #495057;
        }

        /* ===== COVER DESIGN ===== */
        .cover-container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            min-height: 247mm;
        }

        .cover-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .cover-logo {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            margin-bottom: 40px;
        }

        .cover-logo-item {
            text-align: center;
        }

        .cover-logo-item img {
            width: 90px;
            height: 90px;
            object-fit: contain;
        }

        .cover-title {
            margin: 60px 0 40px;
        }

        .cover-title-main {
            font-size: 32px;
            font-weight: 900;
            color: var(--primary-dark);
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 20px;
        }

        .cover-title-sub {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            text-transform: uppercase;
            border-top: 2px solid var(--gray-200);
            border-bottom: 2px solid var(--gray-200);
            padding: 15px 0;
            display: inline-block;
        }

        .cover-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            display: inline-block;
            margin: 30px 0;
            box-shadow: 0 10px 25px rgba(10,88,202,0.2);
        }

        .cover-footer {
            margin-top: auto;
            padding-top: 50px;
        }

        .cover-footer p {
            margin: 5px 0;
            color: var(--gray-600);
        }

        /* ===== NOMOR SURAT ===== */
        .nomor-surat {
            background: var(--gray-100);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 5px solid var(--primary);
            font-size: 14px;
        }

        .nomor-surat table {
            width: 100%;
        }

        .nomor-surat td {
            padding: 5px 0;
        }

        /* ===== STYLE TABEL ===== */
        .tabel-laporan {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin: 20px 0;
        }

        .tabel-laporan th {
            background: var(--primary-light);
            color: var(--primary-dark);
            font-weight: 700;
            padding: 12px 8px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .tabel-laporan td {
            padding: 10px 8px;
            border: 1px solid #dee2e6;
            vertical-align: middle;
        }

        .tabel-laporan tfoot {
            background: var(--gray-100);
            font-weight: 700;
        }

        /* ===== BADGE PRIORITAS ===== */
        .badge-priority-high {
            background: #dc3545;
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }

        .badge-priority-medium {
            background: #ffc107;
            color: black;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }

        .badge-priority-low {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }

        /* ===== BOX INFORMASI ===== */
        .info-box {
            background: var(--gray-100);
            border-left: 6px solid var(--primary);
            padding: 20px;
            border-radius: 0 12px 12px 0;
            margin: 25px 0;
        }

        .info-box-primary {
            background: var(--primary-light);
            border-left-color: var(--primary);
        }

        .info-box-warning {
            background: #fff3cd;
            border-left-color: var(--warning);
        }

        /* ===== STATISTIK CARD ===== */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 25px 0;
        }

        .stat-item {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.02);
        }

        .stat-item h4 {
            font-size: 13px;
            color: var(--gray-600);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-item p {
            font-size: 28px;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-item small {
            color: var(--gray-600);
        }

        /* ===== TANDA TANGAN ===== */
        .ttd-wrapper {
            margin-top: 80px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .ttd-left {
            width: 55%;
        }

        .ttd-right {
            width: 40%;
            text-align: center;
        }

        .ttd-box {
            margin-bottom: 80px;
        }

        .ttd-line {
            width: 250px;
            border-bottom: 1px solid #000;
            margin: 10px 0 5px;
        }

        .ttd-name {
            font-weight: 700;
            text-decoration: underline;
            margin-top: 10px;
        }

        .qrcode-wrapper {
            display: inline-block;
            padding: 10px;
            border: 1px solid var(--gray-200);
            background: white;
            margin: 15px 0;
        }

        /* ===== FOOTER HALAMAN ===== */
        .page-footer {
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px dashed var(--gray-200);
            font-size: 10px;
            color: var(--gray-600);
            text-align: center;
        }

        /* ===== MEDIA PRINT ===== */
        @media print {
            body {
                background: white !important;
            }
            .no-print {
                display: none !important;
            }
            .page-cover, .page-content {
                box-shadow: none;
                margin: 0 auto;
                padding: 25mm 20mm;
            }
            @page {
                size: A4;
                margin: 0;
            }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .stat-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .ttd-wrapper {
                flex-direction: column;
                gap: 40px;
            }
            .ttd-left, .ttd-right {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center;">
        <div class="loading-spinner" style="border: 5px solid #f3f3f3; border-top: 5px solid #0d6efd; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
        <div class="ml-3">Memuat data DTSEN dari Firebase...</div>
    </div>

    <!-- Control Panel (Non-Printable) -->
    <div class="container-fluid bg-light py-3 no-print">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4><i class="fas fa-file-alt text-primary"></i> Laporan Resmi DTSEN</h4>
                    <p class="mb-0 text-muted">Kecamatan Sumber, Kabupaten Cirebon - Periode <span id="periodeTahun">2026</span></p>
                </div>
                <div class="col-md-6 text-right">
                    <button class="btn btn-primary" onclick="generateLaporan()">
                        <i class="fas fa-sync-alt"></i> Generate Laporan
                    </button>
                    <button class="btn btn-success ml-2" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-secondary ml-2" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <a href="index.html" class="btn btn-outline-dark ml-2">
                        <i class="fas fa-arrow-left"></i> Dashboard
                    </a>
                </div>
            </div>
            <div class="row mt-3" id="dataStats"></div>
        </div>
    </div>

    <!-- LAPORAN CONTAINER -->
    <div id="laporanContainer"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // ============================================================
        // FIREBASE INITIALIZATION
        // ============================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs 
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
            authDomain: "data-ke-aksi-auth.firebaseapp.com",
            projectId: "data-ke-aksi-auth",
            storageBucket: "data-ke-aksi-auth.firebasestorage.app",
            messagingSenderId: "631382692174",
            appId: "1:631382692174:web:c10a099fb3021849eace1f"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log('✅ Firebase initialized');
        } catch (error) {
            console.error('❌ Firebase init error:', error);
        }

        // ============================================================
        // GLOBAL VARIABLES
        // ============================================================
        let wilayahData = [];
        let nomorSurat = '';

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        function formatNumber(num) {
            if (num === undefined || num === null) return '0';
            return new Intl.NumberFormat('id-ID').format(num);
        }

        function formatDate(date = new Date()) {
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function generateNomorSurat() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 900 + 100);
            return `460 / ${random} / DTSEN.${month} / TKSK-SBR / ${year}`;
        }

        function generateVerificationId() {
            const date = new Date();
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.random().toString(36).substring(2, 8).toUpperCase();
            return `DTSEN-SBR-${year}${month}${day}-${random}`;
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = show ? 'flex' : 'none';
        }

        // ============================================================
        // LOAD DATA DARI FIREBASE
        // ============================================================
        async function loadDataFromFirebase() {
            try {
                showLoading(true);
                
                const querySnapshot = await getDocs(collection(db, "wilayah_desa"));
                const data = [];
                
                querySnapshot.forEach((doc) => {
                    const docData = doc.data();
                    let desilArray = docData.desil || [];
                    
                    if (!Array.isArray(desilArray)) {
                        if (desilArray && typeof desilArray === 'object') {
                            desilArray = Object.values(desilArray);
                        } else {
                            desilArray = Array(10).fill(0);
                        }
                    }
                    
                    while (desilArray.length < 10) desilArray.push(0);
                    
                    data.push({
                        id: doc.id,
                        nama: docData.nama_wilayah || docData.nama || doc.id,
                        kecamatan: 'Sumber',
                        desil: desilArray,
                        total_kk: desilArray.reduce((a, b) => (a || 0) + (b || 0), 0),
                        d1: desilArray[0] || 0,
                        d2: desilArray[1] || 0,
                        d3: desilArray[2] || 0,
                        d4: desilArray[3] || 0,
                        d5_10: desilArray.slice(4).reduce((a, b) => (a || 0) + (b || 0), 0)
                    });
                });
                
                wilayahData = data.filter(item => item.nama && item.total_kk > 0);
                wilayahData.sort((a, b) => (b.d1 + b.d2) - (a.d1 + a.d2));
                
                console.log(`✅ Data loaded: ${wilayahData.length} villages`);
                updateDataStats();
                
                return wilayahData;
                
            } catch (error) {
                console.error('❌ Error loading from Firebase:', error);
                wilayahData = generateSampleData();
                updateDataStats();
                return wilayahData;
            } finally {
                showLoading(false);
            }
        }

        // Sample data fallback
        function generateSampleData() {
            const desaList = [
                'Sumbergedang', 'Sumberduren', 'Sumbersari', 'Sumberrejo', 'Sumberagung',
                'Sumberpucung', 'Sumberejo Kidul', 'Sumberwono', 'Sumberpatut', 'Sumberkembar',
                'Sumberjaya', 'Sumbermulya', 'Sumberbendo', 'Sumbertengah', 'Sumberkarang'
            ];
            
            return desaList.map((nama, index) => {
                let d1, d2;
                if (index < 5) {
                    d1 = Math.floor(Math.random() * 200) + 350;
                    d2 = Math.floor(Math.random() * 150) + 200;
                } else if (index < 12) {
                    d1 = Math.floor(Math.random() * 150) + 200;
                    d2 = Math.floor(Math.random() * 100) + 100;
                } else {
                    d1 = Math.floor(Math.random() * 100) + 50;
                    d2 = Math.floor(Math.random() * 80) + 30;
                }
                
                const d3 = Math.floor(Math.random() * 100) + 30;
                const d4 = Math.floor(Math.random() * 80) + 20;
                const d5_10 = Math.floor(Math.random() * 200) + 50;
                
                return {
                    id: `sample-${index + 1}`,
                    nama: nama,
                    kecamatan: 'Sumber',
                    desil: [d1, d2, d3, d4, ...Array(6).fill(Math.floor(Math.random() * 30) + 10)],
                    total_kk: d1 + d2 + d3 + d4 + d5_10,
                    d1, d2, d3, d4, d5_10
                };
            }).sort((a, b) => (b.d1 + b.d2) - (a.d1 + a.d2));
        }

        // ============================================================
        // UPDATE STATISTIK
        // ============================================================
        function updateDataStats() {
            const statsContainer = document.getElementById('dataStats');
            
            if (wilayahData.length === 0) {
                statsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">Tidak ada data ditemukan</div>
                    </div>
                `;
                return;
            }
            
            const totalKK = wilayahData.reduce((sum, item) => sum + item.total_kk, 0);
            const totalD12 = wilayahData.reduce((sum, item) => sum + item.d1 + item.d2, 0);
            const prioritasTinggi = wilayahData.filter(i => i.d1 + i.d2 > 500).length;
            
            statsContainer.innerHTML = `
                <div class="col-md-3">
                    <div class="alert alert-info mb-0 py-3">
                        <small>Total Wilayah</small>
                        <h3 class="mb-0 font-weight-bold">${wilayahData.length}</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-primary mb-0 py-3">
                        <small>Total KK DTSEN</small>
                        <h3 class="mb-0 font-weight-bold">${formatNumber(totalKK)}</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-warning mb-0 py-3">
                        <small>Prioritas >500 KK</small>
                        <h3 class="mb-0 font-weight-bold">${prioritasTinggi}</h3>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="alert alert-success mb-0 py-3">
                        <small>Total Prioritas</small>
                        <h3 class="mb-0 font-weight-bold">${formatNumber(totalD12)}</h3>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // GENERATE QR CODE
        // ============================================================
        function generateQRCode(containerId, verificationId) {
            const qrContainer = document.getElementById(containerId);
            if (!qrContainer) return;
            
            qrContainer.innerHTML = '';
            
            const totalKK = wilayahData.reduce((sum, item) => sum + item.total_kk, 0);
            const totalD12 = wilayahData.reduce((sum, item) => sum + item.d1 + item.d2, 0);
            
            const qrData = {
                id: verificationId,
                nomor: nomorSurat,
                instansi: 'TKSK Puskesos Sumber',
                tanggal: formatDate(),
                totalWilayah: wilayahData.length,
                totalKK: totalKK,
                prioritasKK: totalD12,
                kebijakan: 'Prioritas: >500, 300-500, <300',
                penandatangan: 'SHIDIQ HASANUDIN, S.IP'
            };
            
            try {
                new QRCode(qrContainer, {
                    text: JSON.stringify(qrData),
                    width: 100,
                    height: 100,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                console.log('✅ QR Code generated:', verificationId);
            } catch (error) {
                console.error('❌ QR Code error:', error);
                qrContainer.innerHTML = '<div style="padding: 10px; border: 1px solid #ddd; text-align: center;">QR Code</div>';
            }
        }

        // ============================================================
        // BUILD LAPORAN LENGKAP
        // ============================================================
        function buildLaporanHTML() {
            if (wilayahData.length === 0) {
                return '<div class="alert alert-danger">Tidak ada data</div>';
            }
            
            // Generate nomor surat dan ID verifikasi
            nomorSurat = generateNomorSurat();
            const verificationId = generateVerificationId();
            
            // Hitung agregat
            const totalKK = wilayahData.reduce((sum, i) => sum + i.total_kk, 0);
            const totalD1 = wilayahData.reduce((sum, i) => sum + i.d1, 0);
            const totalD2 = wilayahData.reduce((sum, i) => sum + i.d2, 0);
            const totalD12 = totalD1 + totalD2;
            const totalD34 = wilayahData.reduce((sum, i) => sum + (i.d3 || 0) + (i.d4 || 0), 0);
            const totalD510 = wilayahData.reduce((sum, i) => sum + (i.d5_10 || 0), 0);
            
            // Statistik prioritas
            const prioritasTinggi = wilayahData.filter(i => i.d1 + i.d2 > 500).length;
            const prioritasSedang = wilayahData.filter(i => {
                const d12 = i.d1 + i.d2;
                return d12 >= 300 && d12 <= 500;
            }).length;
            const prioritasRendah = wilayahData.filter(i => i.d1 + i.d2 < 300).length;
            
            const totalKKPrioritasTinggi = wilayahData
                .filter(i => i.d1 + i.d2 > 500)
                .reduce((sum, i) => sum + i.d1 + i.d2, 0);
            
            // Top 5 prioritas
            const top5 = wilayahData.slice(0, 5);
            
            // Tabel distribusi desil
            let tabelDistribusi = '';
            wilayahData.forEach((item, index) => {
                tabelDistribusi += `<tr>
                    <td style="text-align: center;">${index + 1}</td>
                    <td><strong>${item.nama}</strong></td>
                    <td style="text-align: right;">${formatNumber(item.total_kk)}</td>
                    <td style="text-align: right;">${formatNumber(item.d1)}</td>
                    <td style="text-align: right;">${formatNumber(item.d2)}</td>
                    <td style="text-align: right;">${formatNumber((item.d3||0) + (item.d4||0))}</td>
                    <td style="text-align: right;">${formatNumber(item.d5_10||0)}</td>
                    <td style="text-align: right; font-weight: 700;">${formatNumber(item.d1 + item.d2)}</td>
                    <td style="text-align: center;">
                        <span class="${(item.d1 + item.d2) > 500 ? 'badge-priority-high' : (item.d1 + item.d2) >= 300 ? 'badge-priority-medium' : 'badge-priority-low'}">
                            ${(item.d1 + item.d2) > 500 ? 'TINGGI' : (item.d1 + item.d2) >= 300 ? 'SEDANG' : 'RENDAH'}
                        </span>
                    </td>
                </tr>`;
            });
            
            // Tabel prioritas (Top 10)
            let tabelPrioritas = '';
            wilayahData.slice(0, 10).forEach((item, index) => {
                const d12 = item.d1 + item.d2;
                const persen = totalD12 > 0 ? ((d12 / totalD12) * 100).toFixed(1) : '0';
                tabelPrioritas += `<tr>
                    <td style="text-align: center;">${index + 1}</td>
                    <td><strong>${item.nama}</strong></td>
                    <td style="text-align: right;">${formatNumber(item.d1)}</td>
                    <td style="text-align: right;">${formatNumber(item.d2)}</td>
                    <td style="text-align: right; font-weight: 700;">${formatNumber(d12)}</td>
                    <td style="text-align: right;">${persen}%</td>
                    <td style="text-align: center;">
                        <span class="${d12 > 500 ? 'badge-priority-high' : d12 >= 300 ? 'badge-priority-medium' : 'badge-priority-low'}">
                            ${d12 > 500 ? 'TINGGI' : d12 >= 300 ? 'SEDANG' : 'RENDAH'}
                        </span>
                    </td>
                </tr>`;
            });

            return `
                <!-- ===== HALAMAN 1: COVER ===== -->
                <div class="page-cover">
                    <div class="cover-container">
                        <!-- Logo -->
                        <div class="cover-header">
                            <div class="cover-logo">
                                <div class="cover-logo-item">
                                    <img src="assets/img/logo/logo-tksk.png" alt="Logo TKSK" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2290%22%20height%3D%2290%22%20viewBox%3D%220%200%2090%2090%22%3E%3Crect%20width%3D%2290%22%20height%3D%2290%22%20fill%3D%22%230a58ca%22%2F%3E%3Ctext%20x%3D%2218%22%20y%3D%2255%22%20font-size%3D%2232%22%20fill%3D%22white%22%3ETKSK%3C%2Ftext%3E%3C%2Fsvg%3E';">
                                    <p style="font-weight: 700; margin-top: 10px;">TKSK</p>
                                </div>
                                <div class="cover-logo-item">
                                    <img src="assets/img/logo/logo-puskesos.png" alt="Logo Puskesos" onerror="this.src='data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2290%22%20height%3D%2290%22%20viewBox%3D%220%200%2090%2090%22%3E%3Crect%20width%3D%2290%22%20height%3D%2290%22%20fill%3D%22%2328a745%22%2F%3E%3Ctext%20x%3D%2212%22%20y%3D%2255%22%20font-size%3D%2228%22%20fill%3D%22white%22%3EPUSKESOS%3C%2Ftext%3E%3C%2Fsvg%3E';">
                                    <p style="font-weight: 700; margin-top: 10px;">Puskesos</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Title -->
                        <div class="cover-title text-center">
                            <h1 class="cover-title-main">LAPORAN RESMI</h1>
                            <h2 class="cover-title-sub">DATA TERPADU SOSIAL EKONOMI NASIONAL</h2>
                            <div class="cover-badge">DTSEN 2026</div>
                        </div>
                        
                        <!-- Info -->
                        <div class="text-center mb-5">
                            <h3 style="font-size: 28px; font-weight: 800; color: #1a2e3f; margin-bottom: 15px;">KECAMATAN SUMBER</h3>
                            <h4 style="font-size: 20px; font-weight: 600; color: #495057;">KABUPATEN CIREBON</h4>
                            <h5 style="font-size: 18px; font-weight: 500; color: #6c757d; margin-top: 10px;">PROVINSI JAWA BARAT</h5>
                        </div>
                        
                        <!-- Periode -->
                        <div class="text-center mt-5 pt-5">
                            <div style="border: 1px solid var(--gray-200); padding: 30px; border-radius: 12px; background: var(--gray-100);">
                                <p style="font-size: 16px; margin-bottom: 5px;">PERIODE PELAPORAN</p>
                                <p style="font-size: 24px; font-weight: 800; color: var(--primary);">${formatDate()}</p>
                            </div>
                        </div>
                        
                        <!-- Footer -->
                        <div class="cover-footer text-center">
                            <p style="font-size: 12px; color: #6c757d;">Dokumen ini disusun oleh Tenaga Kesejahteraan Sosial Kecamatan (TKSK)</p>
                            <p style="font-size: 12px; color: #6c757d;">Bekerjasama dengan Forum Puskesos Kecamatan Sumber</p>
                        </div>
                    </div>
                </div>

                <!-- ===== HALAMAN 2: KOP SURAT & RINGKASAN EKSEKUTIF ===== -->
                <div class="page-content">
                    <!-- Kop Surat -->
                    <div class="kop-surat">
                        <div class="logo-wrapper">
                            <img src="assets/img/logo/logo-tksk.png" alt="TKSK" onerror="this.style.display='none'">
                        </div>
                        <div class="kop-text">
                            <p class="instansi">TENAGA KESEJAHTERAAN SOSIAL KECAMATAN</p>
                            <h2 class="lembaga">FORUM PUSKESOS KECAMATAN SUMBER</h2>
                            <h1 class="program">DARI DATA KE AKSI</h1>
                            <p class="alamat">Jl. Sunan Drajat No.16, Kecamatan Sumber, Kabupaten Cirebon, Jawa Barat 45611</p>
                            <p class="alamat">Telp. (0231) 123456 | Email: tksksumber@cirebonkab.go.id</p>
                        </div>
                        <div class="logo-wrapper text-right">
                            <img src="assets/img/logo/logo-puskesos.png" alt="Puskesos" onerror="this.style.display='none'">
                        </div>
                    </div>
                    
                    <!-- Nomor Surat -->
                    <div class="nomor-surat">
                        <table>
                            <tr>
                                <td width="12%">Nomor</td>
                                <td width="2%">:</td>
                                <td width="86%"><strong>${nomorSurat}</strong></td>
                            </tr>
                            <tr>
                                <td>Sifat</td>
                                <td>:</td>
                                <td>Penting / Segera</td>
                            </tr>
                            <tr>
                                <td>Lampiran</td>
                                <td>:</td>
                                <td>4 (empat) berkas</td>
                            </tr>
                            <tr>
                                <td>Perihal</td>
                                <td>:</td>
                                <td><strong>LAPORAN ANALISIS DATA DTSEN KECAMATAN SUMBER</strong></td>
                            </tr>
                        </table>
                    </div>
                    
                    <!-- Tujuan -->
                    <p style="font-size: 12px; margin-bottom: 25px;">
                        Yth.<br>
                        1. Kepala Dinas Sosial Kabupaten Cirebon<br>
                        2. Camat Sumber<br>
                        di Tempat
                    </p>
                    
                    <!-- Ringkasan Eksekutif -->
                    <h5 style="font-size: 16px; font-weight: 800; margin-bottom: 15px; color: var(--primary-dark);">
                        <i class="fas fa-file-alt mr-2"></i> RINGKASAN EKSEKUTIF
                    </h5>
                    
                    <div class="stat-grid">
                        <div class="stat-item">
                            <h4>Total Wilayah</h4>
                            <p>${wilayahData.length}</p>
                            <small>Desa/Kelurahan</small>
                        </div>
                        <div class="stat-item">
                            <h4>Total KK DTSEN</h4>
                            <p>${formatNumber(totalKK)}</p>
                            <small>Keluarga</small>
                        </div>
                        <div class="stat-item">
                            <h4>Prioritas Tinggi</h4>
                            <p>${prioritasTinggi}</p>
                            <small>Desa (>500 KK)</small>
                        </div>
                        <div class="stat-item">
                            <h4>KK Prioritas</h4>
                            <p>${formatNumber(totalD12)}</p>
                            <small>D1 + D2</small>
                        </div>
                    </div>
                    
                    <div class="info-box info-box-primary">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle fa-2x mr-4 text-primary"></i>
                            <div>
                                <strong>Kriteria Prioritas Intervensi (Kepmensos 79/HUK/2025):</strong><br>
                                <span class="badge-priority-high mr-2">TINGGI >500 KK</span>
                                <span class="badge-priority-medium mr-2">SEDANG 300-500 KK</span>
                                <span class="badge-priority-low">RENDAH <300 KK</span>
                            </div>
                        </div>
                    </div>
                    
                    <p style="font-size: 12px; text-align: justify;">
                        Berdasarkan hasil pendataan dan verifikasi Data Terpadu Kesejahteraan Sosial (DTSEN) di wilayah Kecamatan Sumber, 
                        bersama ini kami sampaikan laporan analisis data kesejahteraan sosial. Total <strong>${formatNumber(totalKK)} KK</strong> 
                        dari <strong>${wilayahData.length} desa/kelurahan</strong> terdata dalam sistem DTSEN. 
                        Kelompok prioritas (Desil 1 dan 2) berjumlah <strong>${formatNumber(totalD12)} KK</strong> atau 
                        <strong>${((totalD12/totalKK)*100).toFixed(1)}%</strong> dari total populasi terdata.
                    </p>
                </div>

                <!-- ===== HALAMAN 3: DISTRIBUSI DESIL ===== -->
                <div class="page-content">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; border-bottom: 1px solid var(--gray-200); padding-bottom: 15px;">
                        <span style="font-size: 14px; font-weight: 600; color: var(--primary-dark);">TKSK - PUSKESOS KEC. SUMBER</span>
                        <span style="font-size: 12px; color: var(--gray-600);">Nomor: <strong>${nomorSurat}</strong></span>
                    </div>
                    
                    <h4 style="font-size: 18px; font-weight: 800; text-align: center; margin-bottom: 25px; text-transform: uppercase; color: var(--dark);">
                        TABEL 1. DISTRIBUSI DESIL PER WILAYAH
                    </h4>
                    
                    <div class="table-responsive">
                        <table class="tabel-laporan">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>Desa/Kelurahan</th>
                                    <th>Total KK</th>
                                    <th>D1</th>
                                    <th>D2</th>
                                    <th>D3-4</th>
                                    <th>D5-10</th>
                                    <th>D1+D2</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tabelDistribusi}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2" style="text-align: right;">TOTAL</td>
                                    <td style="text-align: right;">${formatNumber(totalKK)}</td>
                                    <td style="text-align: right;">${formatNumber(totalD1)}</td>
                                    <td style="text-align: right;">${formatNumber(totalD2)}</td>
                                    <td style="text-align: right;">${formatNumber(totalD34)}</td>
                                    <td style="text-align: right;">${formatNumber(totalD510)}</td>
                                    <td style="text-align: right;">${formatNumber(totalD12)}</td>
                                    <td style="text-align: center;">-</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="info-box" style="margin-top: 30px; background: var(--primary-light);">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-chart-pie fa-2x mr-4 text-primary"></i>
                            <div>
                                <strong>Keterangan:</strong> D1 (Sangat Miskin), D2 (Miskin), D3-4 (Rentan), 
                                D5 (Menengah Bawah), D6-10 (Menengah ke Atas). Prioritas intervensi difokuskan pada D1+D2.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== HALAMAN 4: PRIORITAS INTERVENSI ===== -->
                <div class="page-content">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; border-bottom: 1px solid var(--gray-200); padding-bottom: 15px;">
                        <span style="font-size: 14px; font-weight: 600; color: var(--primary-dark);">TKSK - PUSKESOS KEC. SUMBER</span>
                        <span style="font-size: 12px; color: var(--gray-600);">Nomor: <strong>${nomorSurat}</strong></span>
                    </div>
                    
                    <h4 style="font-size: 18px; font-weight: 800; text-align: center; margin-bottom: 25px; text-transform: uppercase; color: var(--dark);">
                        TABEL 2. PRIORITAS INTERVENSI DTSEN
                    </h4>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div style="background: #f8f9fa; border-left: 6px solid #dc3545; padding: 15px;">
                                <span class="badge-priority-high mb-2">PRIORITAS TINGGI</span>
                                <h3 style="font-size: 24px; font-weight: 800; margin: 5px 0;">${prioritasTinggi}</h3>
                                <small>Desa dengan D1+D2 >500 KK</small>
                                <div style="margin-top: 10px; font-size: 13px;">
                                    <strong>Total KK:</strong> ${formatNumber(totalKKPrioritasTinggi)}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="background: #f8f9fa; border-left: 6px solid #ffc107; padding: 15px;">
                                <span class="badge-priority-medium mb-2">PRIORITAS SEDANG</span>
                                <h3 style="font-size: 24px; font-weight: 800; margin: 5px 0;">${prioritasSedang}</h3>
                                <small>Desa dengan D1+D2 300-500 KK</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div style="background: #f8f9fa; border-left: 6px solid #28a745; padding: 15px;">
                                <span class="badge-priority-low mb-2">PRIORITAS RENDAH</span>
                                <h3 style="font-size: 24px; font-weight: 800; margin: 5px 0;">${prioritasRendah}</h3>
                                <small>Desa dengan D1+D2 <300 KK</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="tabel-laporan">
                            <thead>
                                <tr>
                                    <th>Rank</th>
                                    <th>Desa/Kelurahan</th>
                                    <th>D1</th>
                                    <th>D2</th>
                                    <th>Total D1+D2</th>
                                    <th>% Total Prioritas</th>
                                    <th>Kategori</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tabelPrioritas}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="info-box-warning" style="margin-top: 30px; padding: 20px; border-radius: 8px;">
                        <h6 style="font-weight: 800; margin-bottom: 15px; color: #856404;">
                            <i class="fas fa-exclamation-triangle mr-2"></i> REKOMENDASI:
                        </h6>
                        <ul style="margin-bottom: 0;">
                            <li>Intervensi segera di <strong>${top5.map(d => d.nama).slice(0, 3).join(', ')}</strong> dan wilayah prioritas tinggi lainnya.</li>
                            <li>Monitoring intensif untuk ${prioritasSedang} desa dengan prioritas sedang.</li>
                            <li>Koordinasi dengan Dinas Sosial untuk percepatan penyaluran bansos.</li>
                            <li>Pendampingan keluarga prioritas oleh TKSK dan Puskesos.</li>
                        </ul>
                    </div>
                </div>

                <!-- ===== HALAMAN 5: PENUTUP DAN TANDA TANGAN ===== -->
                <div class="page-content">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; border-bottom: 1px solid var(--gray-200); padding-bottom: 15px;">
                        <span style="font-size: 14px; font-weight: 600; color: var(--primary-dark);">TKSK - PUSKESOS KEC. SUMBER</span>
                        <span style="font-size: 12px; color: var(--gray-600);">Nomor: <strong>${nomorSurat}</strong></span>
                    </div>
                    
                    <h4 style="font-size: 18px; font-weight: 800; text-align: center; margin-bottom: 35px; text-transform: uppercase; color: var(--dark);">
                        PENUTUP
                    </h4>
                    
                    <div style="font-size: 12px; line-height: 1.8; text-align: justify; margin-bottom: 40px;">
                        <p>
                            Demikian laporan analisis Data Terpadu Sosial Ekonomi Nasional (DTSEN) Kecamatan Sumber ini kami sampaikan. 
                            Laporan ini disusun berdasarkan data real-time dari Firebase Firestore yang telah diverifikasi oleh 
                            Tenaga Kesejahteraan Sosial Kecamatan (TKSK) dan Forum Puskesos Kecamatan Sumber.
                        </p>
                        <p>
                            Kami berharap laporan ini dapat menjadi acuan dalam perencanaan, pelaksanaan, dan evaluasi program 
                            kesejahteraan sosial di Kecamatan Sumber, sehingga bantuan sosial dapat tepat sasaran, tepat waktu, 
                            dan akuntabel. Atas perhatian dan kerjasamanya, kami ucapkan terima kasih.
                        </p>
                    </div>
                    
                    <!-- Tanda Tangan -->
                    <div class="ttd-wrapper">
                        <div class="ttd-left">
                            <div class="verifikasi-box" style="border: 1px solid #000; padding: 20px; background: #fcfcfc; border-radius: 8px;">
                                <strong style="font-size: 11px;">⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻</strong><br>
                                <strong style="font-size: 13px;">VERIFIKASI DAN VALIDASI DATA:</strong><br>
                                ✓ Data bersumber dari Database DTSEN Kementerian Sosial RI<br>
                                ✓ Telah diverifikasi oleh Tenaga Kesejahteraan Sosial Kecamatan (TKSK)<br>
                                ✓ Kriteria Prioritas: <strong>Tinggi >500 | Sedang 300-500 | Rendah <300</strong><br>
                                ✓ Berlaku untuk periode <strong>${new Date().getFullYear()}</strong><br>
                                <span style="color: #666;">* Dokumen ini ditandatangani secara elektronik</span>
                            </div>
                        </div>
                        
                        <div class="ttd-right">
                            <p style="font-size: 12px; margin-bottom: 5px;">Ditetapkan di : Sumber</p>
                            <p style="font-size: 12px; margin-bottom: 15px;">Pada tanggal : <strong>${formatDate()}</strong></p>
                            
                            <p style="font-size: 12px; margin-bottom: 5px;">Koordinator TKSK Kecamatan Sumber,</p>
                            
                            <div id="qrcodeTTD" class="qrcode-wrapper" style="margin: 15px auto;"></div>
                            
                            <p class="ttd-name">
                                SHIDIQ HASANUDIN, S.IP
                            </p>
                            
                            <p style="font-size: 11px; margin-top: 10px; color: #666;">
                                NIP. 19850625 200901 1 003
                            </p>
                            
                            <p style="font-size: 10px; margin-top: 15px; color: #666; word-break: break-all;">
                                ID Verifikasi: <strong id="verificationIdDisplay">${verificationId}</strong>
                            </p>
                        </div>
                    </div>
                    
                    <div class="page-footer">
                        <span>Dokumen ini diterbitkan secara elektronik dan sah tanpa tanda tangan basah</span><br>
                        <span>⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻</span>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // GENERATE LAPORAN
        // ============================================================
        function generateLaporan() {
            if (wilayahData.length === 0) {
                alert('Tidak ada data untuk di-generate');
                return;
            }
            
            const laporanContainer = document.getElementById('laporanContainer');
            laporanContainer.innerHTML = buildLaporanHTML();
            
            // Generate QR Code
            setTimeout(() => {
                const verificationId = document.getElementById('verificationIdDisplay')?.innerText || generateVerificationId();
                generateQRCode('qrcodeTTD', verificationId);
            }, 100);
            
            console.log('✅ Laporan resmi generated');
        }

        // ============================================================
        // EXPORT PDF
        // ============================================================
        function exportPDF() {
            const element = document.getElementById('laporanContainer');
            const opt = {
                margin: [15, 15, 15, 15],
                filename: `Laporan_DTSEN_Kecamatan_Sumber_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            setTimeout(() => {
                html2pdf().set(opt).from(element).save();
            }, 500);
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        window.generateLaporan = generateLaporan;
        window.exportPDF = exportPDF;
        window.loadDataFromFirebase = loadDataFromFirebase;

        document.addEventListener('DOMContentLoaded', async function() {
            await loadDataFromFirebase();
            generateLaporan();
            
            setInterval(async () => {
                await loadDataFromFirebase();
                generateLaporan();
            }, 5 * 60 * 1000);
        });

    </script>
</body>
</html>
