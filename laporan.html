<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laporan DTSEN - TKSK & Puskesos Kecamatan Sumber</title>
    
    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- Print & PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body {
            font-family: 'Times New Roman', serif;
            background-color: #f8f9fa;
        }
        
        .page {
            background: white;
            padding: 25mm;
            margin: 20px auto;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            min-height: 297mm;
            position: relative;
        }
        
        .kop-surat {
            text-align: center;
            border-bottom: 3px solid #000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .kop-surat h2 {
            font-weight: bold;
            margin: 5px 0;
        }
        
        .kop-surat h4 {
            margin: 3px 0;
        }
        
        .logo-header {
            height: 80px;
            margin: 0 15px;
        }
        
        .table-laporan {
            font-size: 12px;
        }
        
        .table-laporan th {
            background-color: #f2f2f2;
            text-align: center;
            vertical-align: middle;
        }
        
        .badge-prioritas {
            font-size: 11px;
            padding: 4px 8px;
        }
        
        .ttd-section {
            margin-top: 80px;
        }
        
        .ttd-box {
            height: 100px;
            border-bottom: 1px solid #000;
            margin-bottom: 10px;
        }
        
        @media print {
            body {
                background: white !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .page {
                box-shadow: none;
                margin: 0;
                padding: 20mm;
                page-break-after: always;
            }
            
            @page {
                size: A4;
                margin: 15mm;
            }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #007bff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        /* QR Code Styling */
        #qrcodeTTD {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            padding: 5px;
            border: 1px solid #ddd;
            background: white;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="ml-3">Memuat data dari Firebase...</div>
    </div>

    <!-- Control Panel (Non-Printable) -->
    <div class="container-fluid bg-light py-3 no-print">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4><i class="fas fa-chart-line text-primary"></i> Laporan DTSEN - Dashboard</h4>
                    <p class="mb-0 text-muted">Data real-time dari Firebase Firestore</p>
                </div>
                <div class="col-md-6 text-right">
                    <button class="btn btn-primary" onclick="generateLaporan()">
                        <i class="fas fa-sync-alt"></i> Generate Laporan
                    </button>
                    <button class="btn btn-success ml-2" onclick="exportPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="btn btn-secondary ml-2" onclick="window.print()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <a href="index.html" class="btn btn-outline-dark ml-2">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </a>
                </div>
            </div>
            
            <!-- Data Stats -->
            <div class="row mt-3" id="dataStats">
                <!-- Stats will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Laporan Container -->
    <div class="container mt-4">
        <div id="laporanContainer">
            <!-- Laporan akan di-generate di sini -->
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
            authDomain: "data-ke-aksi-auth.firebaseapp.com",
            projectId: "data-ke-aksi-auth",
            storageBucket: "data-ke-aksi-auth.firebasestorage.app",
            messagingSenderId: "631382692174",
            appId: "1:631382692174:web:c10a099fb3021849eace1f"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global Variables
        let cachedData = [];
        let chartInstances = [];

        // Fungsi untuk memuat data dari Firebase
        async function loadDataFromFirebase() {
            try {
                showLoading(true);
                
                // Ambil data dari koleksi 'wilayah_desa'
                const querySnapshot = await getDocs(collection(db, "wilayah_desa"));
                
                cachedData = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    cachedData.push({
                        id: doc.id,
                        nama: data.nama || data.nama_wilayah || 'N/A',
                        desil: data.desil || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                        timestamp: data.timestamp || new Date().toISOString()
                    });
                });
                
                console.log('Data loaded from Firebase:', cachedData.length, 'records');
                
                // Tampilkan stats
                updateDataStats();
                
                // Generate laporan otomatis
                generateLaporan();
                
            } catch (error) {
                console.error('Error loading data from Firebase:', error);
                alert('Gagal memuat data dari Firebase: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        // Fungsi untuk menampilkan/menyembunyikan loading
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = show ? 'flex' : 'none';
        }

        // Fungsi untuk update data stats
        function updateDataStats() {
            const statsContainer = document.getElementById('dataStats');
            
            if (cachedData.length === 0) {
                statsContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Tidak ada data ditemukan di Firebase
                        </div>
                    </div>
                `;
                return;
            }
            
            // Hitung total per desil
            const totalDesil = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            let totalKK = 0;
            
            cachedData.forEach(item => {
                if (item.desil && Array.isArray(item.desil)) {
                    item.desil.forEach((count, index) => {
                        totalDesil[index] += Number(count) || 0;
                    });
                    totalKK += item.desil.reduce((a, b) => a + (Number(b) || 0), 0);
                }
            });
            
            const totalD1D2 = totalDesil[0] + totalDesil[1];
            
            statsContainer.innerHTML = `
                <div class="col-md-3">
                    <div class="summary-card">
                        <h6>Total Data Wilayah</h6>
                        <h3>${cachedData.length}</h3>
                        <small><i class="fas fa-map-marker-alt"></i> Kelurahan/Desa</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h6>Total KK Terdata</h6>
                        <h3>${totalKK.toLocaleString('id-ID')}</h3>
                        <small><i class="fas fa-home"></i> Kepala Keluarga</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h6>KK Prioritas (D1-D2)</h6>
                        <h3>${totalD1D2.toLocaleString('id-ID')}</h3>
                        <small><i class="fas fa-exclamation-triangle"></i> Butuh Intervensi</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h6>Persentase Prioritas</h6>
                        <h3>${totalKK > 0 ? ((totalD1D2 / totalKK) * 100).toFixed(1) : '0'}%</h3>
                        <small><i class="fas fa-chart-pie"></i> dari Total KK</small>
                    </div>
                </div>
            `;
        }

        // Fungsi untuk generate laporan
        function generateLaporan() {
            if (cachedData.length === 0) {
                alert('Tidak ada data untuk di-generate. Silakan tunggu atau refresh halaman.');
                return;
            }
            
            // Hancurkan chart sebelumnya
            chartInstances.forEach(chart => chart.destroy());
            chartInstances = [];
            
            // Generate konten laporan
            const laporanContainer = document.getElementById('laporanContainer');
            laporanContainer.innerHTML = buildLaporanHTML();
            
            // Render charts dan QR code
            setTimeout(() => {
                renderCharts();
                generateQRCode(); // Panggil fungsi generateQRCode
            }, 100);
        }

        // Fungsi untuk membangun HTML laporan
        function buildLaporanHTML() {
            const now = new Date();
            const formattedDate = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // Hitung aggregat data
            const totalDesil = [0, 0, 0, 0, 0, 0]; // D1, D2, D3, D4, D5, D6-D10
            let totalKK = 0;
            
            cachedData.forEach(item => {
                const desil = item.desil || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                
                // D1
                totalDesil[0] += Number(desil[0]) || 0;
                // D2
                totalDesil[1] += Number(desil[1]) || 0;
                // D3
                totalDesil[2] += Number(desil[2]) || 0;
                // D4
                totalDesil[3] += Number(desil[3]) || 0;
                // D5
                totalDesil[4] += Number(desil[4]) || 0;
                // D6-D10
                totalDesil[5] += desil.slice(5).reduce((sum, val) => sum + (Number(val) || 0), 0);
                
                totalKK += desil.reduce((a, b) => a + (Number(b) || 0), 0);
            });
            
            const totalD1D2 = totalDesil[0] + totalDesil[1];
            
            // Urutkan data berdasarkan total D1+D2 (descending)
            const sortedData = [...cachedData].sort((a, b) => {
                const aD12 = (Number(a.desil[0]) || 0) + (Number(a.desil[1]) || 0);
                const bD12 = (Number(b.desil[0]) || 0) + (Number(b.desil[1]) || 0);
                return bD12 - aD12;
            });
            
            // Tentukan wilayah dengan prioritas tertinggi
            const topWilayah = sortedData[0];
            const topD12 = (Number(topWilayah.desil[0]) || 0) + (Number(topWilayah.desil[1]) || 0);
            
            // Bangun tabel prioritas
            let tabelPrioritasHTML = '';
            sortedData.forEach((item, index) => {
                const d1 = Number(item.desil[0]) || 0;
                const d2 = Number(item.desil[1]) || 0;
                const d12 = d1 + d2;
                const persentase = totalD1D2 > 0 ? ((d12 / totalD1D2) * 100).toFixed(1) : '0';
                
                let prioritas = 'Rendah';
                let badgeClass = 'badge-success';
                
                if (d12 >= 400) {
                    prioritas = 'Tinggi';
                    badgeClass = 'badge-danger';
                } else if (d12 >= 200) {
                    prioritas = 'Sedang';
                    badgeClass = 'badge-warning';
                }
                
                tabelPrioritasHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.nama || 'N/A'}</td>
                        <td class="text-center">${d1.toLocaleString('id-ID')}</td>
                        <td class="text-center">${d2.toLocaleString('id-ID')}</td>
                        <td class="text-center font-weight-bold">${d12.toLocaleString('id-ID')}</td>
                        <td class="text-center">${persentase}%</td>
                        <td class="text-center">
                            <span class="badge ${badgeClass} badge-prioritas">${prioritas}</span>
                        </td>
                    </tr>
                `;
            });
            
            return `
                <!-- HALAMAN 1: COVER -->
                <div class="page">
                    <div class="kop-surat">
                        <div class="d-flex justify-content-center align-items-center mb-3">
                            <img src="assets/img/logo/logo-tksk.png" alt="TKSK" class="logo-header">
                            <div class="text-center mx-4">
                                <h6 style="margin: 0; font-size: 14px;">TENAGA KESEJAHTERAAN SOSIAL KECAMATAN (TKSK)</h6>
                                <h4 style="margin: 5px 0; font-weight: bold;">FORUM PUSKESOS KECAMATAN SUMBER</h4>
                                <h2 style="margin: 10px 0; font-weight: bold; color: #2c3e50;">DARI DATA KE AKSI</h2>
                                <p style="margin: 0; font-size: 12px;">Sekretariat: Jl. Sunan Malik Ibrahin No.02, Kecamatan Sumber</p>
                            </div>
                            <img src="assets/img/logo/logo-puskesos.png" alt="Puskesos" class="logo-header">
                        </div>
                    </div>
                    
                    <div class="text-center mt-5 pt-5">
                        <h1 class="font-weight-bold" style="color: #2c3e50;">LAPORAN ANALISIS DTSEN</h1>
                        <h3 class="mt-4">KECAMATAN SUMBER</h3>
                        <h4>KABUPATEN CIREBON</h4>
                        <h5>PROVINSI JAWA BARAT</h5>
                        
                        <div class="mt-5 pt-5">
                            <h4>PERIODE: ${formattedDate}</h4>
                        </div>
                    </div>
                    
                    <div class="text-center mt-5 pt-5">
                        <p><em>"Data yang akurat untuk kebijakan yang tepat sasaran"</em></p>
                    </div>
                </div>

                <!-- HALAMAN 2: EXECUTIVE SUMMARY -->
                <div class="page">
                    <div class="kop-surat">
                        <h4>LAPORAN ANALISIS DTSEN</h4>
                        <h5>KECAMATAN SUMBER - LAPORAN KEMISKINAN</h5>
                    </div>
                    
                    <h5 class="mt-4">Ringkasan Kemiskinan</h5>
                    <p class="text-justify">
                        Laporan ini menyajikan analisis komprehensif Data Terpadu Sosial Ekonomi Nasional (DTSEN) di Kecamatan Sumber. 
                        Data diambil dari database Firebase Firestore yang diperbarui secara real-time oleh Tim TKSK dan Puskesos.
                    </p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Statistik Utama</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm">
                                        <tr>
                                            <td>Total Wilayah Terdata</td>
                                            <td class="text-right font-weight-bold">${cachedData.length}</td>
                                        </tr>
                                        <tr>
                                            <td>Total KK Terdata</td>
                                            <td class="text-right font-weight-bold">${totalKK.toLocaleString('id-ID')}</td>
                                        </tr>
                                        <tr>
                                            <td>KK Desil 1 (Sangat Miskin)</td>
                                            <td class="text-right font-weight-bold text-danger">${totalDesil[0].toLocaleString('id-ID')}</td>
                                        </tr>
                                        <tr>
                                            <td>KK Desil 2 (Miskin)</td>
                                            <td class="text-right font-weight-bold text-warning">${totalDesil[1].toLocaleString('id-ID')}</td>
                                        </tr>
                                        <tr>
                                            <td>Total Prioritas (D1+D2)</td>
                                            <td class="text-right font-weight-bold">${totalD1D2.toLocaleString('id-ID')}</td>
                                        </tr>
                                        <tr>
                                            <td>Persentase Prioritas</td>
                                            <td class="text-right font-weight-bold">${totalKK > 0 ? ((totalD1D2 / totalKK) * 100).toFixed(1) : '0'}%</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Wilayah Prioritas Tertinggi</h6>
                                </div>
                                <div class="card-body text-center">
                                    <h3 class="text-danger">${topWilayah.nama || 'N/A'}</h3>
                                    <p class="mb-1">Memiliki total KK prioritas:</p>
                                    <h2 class="font-weight-bold">${topD12.toLocaleString('id-ID')} KK</h2>
                                    <p class="text-muted mb-0">(${totalD1D2 > 0 ? ((topD12 / totalD1D2) * 100).toFixed(1) : '0'}% dari total prioritas kecamatan)</p>
                                    <div class="mt-3">
                                        <span class="badge badge-danger badge-pill px-3 py-2">PRIORITAS TINGGI</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Rekomendasi Aksi Segera:</h5>
                        <ol>
                            <li>Fokuskan intervensi di ${topWilayah.nama || 'N/A'} sebagai wilayah prioritas tertinggi</li>
                            <li>Koordinasi dengan Dinas Sosial untuk percepatan penyaluran bantuan sosial</li>
                            <li>Pelaksanaan pendampingan intensif oleh TKSK dan Puskesos setempat</li>
                            <li>Pemantauan berkala perkembangan kondisi sosial ekonomi</li>
                        </ol>
                    </div>
                </div>

                <!-- HALAMAN 3: DISTRIBUSI DESIL -->
                <div class="page">
                    <div class="kop-surat">
                        <h4>LAPORAN ANALISIS DTSEN</h4>
                        <h5>DISTRIBUSI KELOMPOK DESIL KECAMATAN SUMBER</h5>
                    </div>
                    
                    <h5 class="mt-4">Grafik Distribusi Kelompok Desil</h5>
                    <div class="chart-container">
                        <canvas id="chartDistribusiDesil"></canvas>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Tabel Distribusi Desil per Wilayah</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm table-laporan">
                                <thead class="thead-light">
                                    <tr>
                                        <th>No</th>
                                        <th>Wilayah</th>
                                        <th class="text-center">D1</th>
                                        <th class="text-center">D2</th>
                                        <th class="text-center">D3</th>
                                        <th class="text-center">D4</th>
                                        <th class="text-center">D5</th>
                                        <th class="text-center">D6-D10</th>
                                        <th class="text-center">Total</th>
                                        <th class="text-center">D1+D2</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sortedData.map((item, index) => {
                                        const desil = item.desil || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                                        const d1 = Number(desil[0]) || 0;
                                        const d2 = Number(desil[1]) || 0;
                                        const d3 = Number(desil[2]) || 0;
                                        const d4 = Number(desil[3]) || 0;
                                        const d5 = Number(desil[4]) || 0;
                                        const d6d10 = desil.slice(5).reduce((sum, val) => sum + (Number(val) || 0), 0);
                                        const total = d1 + d2 + d3 + d4 + d5 + d6d10;
                                        const d12 = d1 + d2;
                                        
                                        return `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${item.nama || 'N/A'}</td>
                                                <td class="text-center">${d1.toLocaleString('id-ID')}</td>
                                                <td class="text-center">${d2.toLocaleString('id-ID')}</td>
                                                <td class="text-center">${d3.toLocaleString('id-ID')}</td>
                                                <td class="text-center">${d4.toLocaleString('id-ID')}</td>
                                                <td class="text-center">${d5.toLocaleString('id-ID')}</td>
                                                <td class="text-center">${d6d10.toLocaleString('id-ID')}</td>
                                                <td class="text-center font-weight-bold">${total.toLocaleString('id-ID')}</td>
                                                <td class="text-center font-weight-bold ${d12 >= 400 ? 'text-danger' : d12 >= 200 ? 'text-warning' : 'text-success'}">${d12.toLocaleString('id-ID')}</td>
                                            </tr>
                                        `;
                                    }).join('')}
                                    <tr class="table-secondary font-weight-bold">
                                        <td colspan="2">TOTAL KECAMATAN</td>
                                        <td class="text-center">${totalDesil[0].toLocaleString('id-ID')}</td>
                                        <td class="text-center">${totalDesil[1].toLocaleString('id-ID')}</td>
                                        <td class="text-center">${totalDesil[2].toLocaleString('id-ID')}</td>
                                        <td class="text-center">${totalDesil[3].toLocaleString('id-ID')}</td>
                                        <td class="text-center">${totalDesil[4].toLocaleString('id-ID')}</td>
                                        <td class="text-center">${totalDesil[5].toLocaleString('id-ID')}</td>
                                        <td class="text-center">${totalKK.toLocaleString('id-ID')}</td>
                                        <td class="text-center">${totalD1D2.toLocaleString('id-ID')}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- HALAMAN 4: PRIORITAS WILAYAH -->
                <div class="page">
                    <div class="kop-surat">
                        <h4>LAPORAN ANALISIS DTSEN</h4>
                        <h5>PEMETAAN PRIORITAS WILAYAH INTERVENSI</h5>
                    </div>
                    
                    <h5 class="mt-4">Grafik Prioritas Wilayah (D1+D2)</h5>
                    <div class="chart-container">
                        <canvas id="chartPrioritasWilayah"></canvas>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Tabel Prioritas Intervensi</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered table-sm table-laporan">
                                <thead class="thead-light">
                                    <tr>
                                        <th>No</th>
                                        <th>Wilayah</th>
                                        <th class="text-center">D1</th>
                                        <th class="text-center">D2</th>
                                        <th class="text-center">Total D1+D2</th>
                                        <th class="text-center">% Terhadap Total Prioritas</th>
                                        <th class="text-center">Tingkat Prioritas</th>
                                        <th class="text-center">Keterangan</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${tabelPrioritasHTML}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h5>Kriteria Prioritas:</h5>
                        <ul>
                            <li><span class="badge badge-danger">Tinggi</span>: â‰¥ 400 KK prioritas (D1+D2)</li>
                            <li><span class="badge badge-warning">Sedang</span>: 200-399 KK prioritas (D1+D2)</li>
                            <li><span class="badge badge-success">Rendah</span>: < 200 KK prioritas (D1+D2)</li>
                        </ul>
                    </div>
                </div>

                <!-- HALAMAN 5: ANALISIS DAN REKOMENDASI -->
                <div class="page">
                    <div class="kop-surat">
                        <h4>LAPORAN ANALISIS DTSEN</h4>
                        <h5>ANALISIS MENDALAM DAN REKOMENDASI STRATEGIS</h5>
                    </div>
                    
                    <h5 class="mt-4">Analisis Kondisi Sosial Ekonomi</h5>
                    <div class="text-justify">
                        <p>
                            Berdasarkan data DTSEN yang terkumpul dari ${cachedData.length} wilayah di Kecamatan Sumber, 
                            teridentifikasi <strong>${totalD1D2.toLocaleString('id-ID')} KK</strong> yang termasuk dalam kategori prioritas 
                            (Desil 1 dan 2). Angka ini merepresentasikan <strong>${totalKK > 0 ? ((totalD1D2 / totalKK) * 100).toFixed(1) : '0'}%</strong> 
                            dari total populasi terdata.
                        </p>
                        
                        <p>
                            Wilayah <strong>${topWilayah.nama || 'N/A'}</strong> menjadi fokus utama dengan 
                            kontribusi <strong>${totalD1D2 > 0 ? ((topD12 / totalD1D2) * 100).toFixed(1) : '0'}%</strong> dari total KK prioritas kecamatan. 
                            Kondisi ini mengindikasikan konsentrasi kerentanan sosial ekonomi yang memerlukan intervensi terpadu.
                        </p>
                    </div>
                    
                    <h5 class="mt-4">Rekomendasi Program Intervensi</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card border-info mb-3">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-hands-helping"></i> Intervensi Jangka Pendek (0-3 Bulan)</h6>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>Penyaluran Bantuan Sosial Tunai (BST) secara tepat sasaran</li>
                                        <li>Bantuan pangan non-tunai untuk keluarga dengan balita dan lansia</li>
                                        <li>Program sembako murah di titik-titik kerentanan tinggi</li>
                                        <li>Pelayanan kesehatan gratis di Puskesmas dan Puskesos</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-success mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-seedling"></i> Intervensi Jangka Menengah (3-12 Bulan)</h6>
                                </div>
                                <div class="card-body">
                                    <ul>
                                        <li>Pelatihan keterampilan dan kewirausahaan</li>
                                        <li>Program padat karya tunai untuk infrastruktur desa</li>
                                        <li>Pengembangan usaha mikro kelompok perempuan</li>
                                        <li>Pendampingan pengajuan KUR (Kredit Usaha Rakyat)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mt-4">Indikator Keberhasilan</h5>
                    <table class="table table-bordered table-sm">
                        <thead class="thead-light">
                            <tr>
                                <th>Indikator</th>
                                <th>Target 6 Bulan</th>
                                <th>Target 12 Bulan</th>
                                <th>Satuan</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Penurunan KK Desil 1</td>
                                <td class="text-center">15%</td>
                                <td class="text-center">30%</td>
                                <td>% dari baseline</td>
                            </tr>
                            <tr>
                                <td>Peningkatan akses layanan kesehatan</td>
                                <td class="text-center">80%</td>
                                <td class="text-center">95%</td>
                                <td>KK prioritas terlayani</td>
                            </tr>
                            <tr>
                                <td>Penyerapan program pelatihan</td>
                                <td class="text-center">200</td>
                                <td class="text-center">500</td>
                                <td>orang terlatih</td>
                            </tr>
                            <tr>
                                <td>Pengembangan usaha mikro baru</td>
                                <td class="text-center">50</td>
                                <td class="text-center">120</td>
                                <td>unit usaha</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- HALAMAN 6: PENUTUP DAN TTD -->
                <div class="page">
                    <div class="kop-surat">
                        <h4>LAPORAN ANALISIS DTSEN</h4>
                        <h5>PENUTUP DAN PENANDATANGANAN</h5>
                    </div>
                    
                    <div class="text-justify mt-4">
                        <h5>Kesimpulan</h5>
                        <p>
                            Data DTSEN Kecamatan Sumber menunjukkan bahwa terdapat <strong>${totalD1D2.toLocaleString('id-ID')} KK</strong> yang memerlukan 
                            perhatian khusus melalui program perlindungan sosial. Dengan pendekatan berbasis data yang akurat, 
                            diharapkan intervensi dapat lebih tepat sasaran, efektif, dan efisien dalam mengurangi tingkat 
                            kerentanan sosial ekonomi masyarakat.
                        </p>
                        
                        <p>
                            Laporan ini diharapkan dapat menjadi acuan bagi seluruh pemangku kepentingan dalam perencanaan, 
                            implementasi, dan evaluasi program kesejahteraan sosial di Kecamatan Sumber.
                        </p>
                    </div>
                    
                    <div class="ttd-section">
                        <div class="row">
                            <div class="col-6">
                                <p class="text-center">Mengetahui,<br>Camat Sumber</p>
                                <div class="ttd-box"></div>
                                <p class="text-center font-weight-bold">(.................................)</p>
                                <p class="text-center">NIP. .................................</p>
                            </div>
                            
                            <div class="col-6">
                                <p class="text-center">Menyusun,<br>TKSK Kecamatan Sumber</p>
                                <div class="text-center mb-3">
                                    <div id="qrcodeTTD"></div>
                                </div>
                                <p class="text-center font-weight-bold">SHIDIQ HASANUDIN, S.IP</p>
                                <p class="text-center">ID TKSK: TK-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}</p>
                                <p class="text-center text-muted">Sumber, ${now.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-5 pt-5">
                        <div class="alert alert-light border">
                            <small>
                                <strong>Catatan:</strong><br>
                                1. Laporan ini dihasilkan secara otomatis dari sistem database DTSEN<br>
                                2. Data bersumber dari verifikasi lapangan oleh TKSK dan Puskesos<br>
                                3. Dokumen ini valid hingga diperbarui dengan data terbaru<br>
                                4. QR Code memuat metadata verifikasi dokumen
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }

        // Fungsi untuk render charts
        function renderCharts() {
            // Hitung total per desil dengan D6-D10 digabung
            const totalDesil = [0, 0, 0, 0, 0, 0]; // D1, D2, D3, D4, D5, D6-D10
            
            cachedData.forEach(item => {
                const desil = item.desil || [0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
                totalDesil[0] += Number(desil[0]) || 0; // D1
                totalDesil[1] += Number(desil[1]) || 0; // D2
                totalDesil[2] += Number(desil[2]) || 0; // D3
                totalDesil[3] += Number(desil[3]) || 0; // D4
                totalDesil[4] += Number(desil[4]) || 0; // D5
                totalDesil[5] += desil.slice(5).reduce((sum, val) => sum + (Number(val) || 0), 0); // D6-D10
            });
            
            // Chart 1: Distribusi Desil (D6-D10 digabung)
            const ctx1 = document.getElementById('chartDistribusiDesil');
            if (ctx1) {
                const chart1 = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: ["D1", "D2", "D3", "D4", "D5", "D6-D10"],
                        datasets: [{
                            label: 'Jumlah KK',
                            data: totalDesil,
                            backgroundColor: [
                                '#dc3545', // D1 - merah
                                '#fd7e14', // D2 - oranye
                                '#ffc107', // D3 - kuning
                                '#28a745', // D4 - hijau
                                '#20c997', // D5 - hijau muda
                                '#6c757d'  // D6-D10 - abu-abu
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw;
                                        const total = totalDesil.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${value.toLocaleString('id-ID')} KK (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Jumlah KK'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('id-ID');
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Kelompok Desil'
                                }
                            }
                        }
                    }
                });
                chartInstances.push(chart1);
            }
            
            // Chart 2: Prioritas Wilayah (D1+D2 per wilayah)
            const sortedData = [...cachedData].sort((a, b) => {
                const aD12 = (Number(a.desil[0]) || 0) + (Number(a.desil[1]) || 0);
                const bD12 = (Number(b.desil[0]) || 0) + (Number(b.desil[1]) || 0);
                return bD12 - aD12;
            });
            
            const ctx2 = document.getElementById('chartPrioritasWilayah');
            if (ctx2) {
                const labels = sortedData.map(item => 
                    item.nama.length > 20 ? item.nama.substring(0, 20) + '...' : item.nama
                );
                const dataD1 = sortedData.map(item => Number(item.desil[0]) || 0);
                const dataD2 = sortedData.map(item => Number(item.desil[1]) || 0);
                const dataD12 = sortedData.map(item => 
                    (Number(item.desil[0]) || 0) + (Number(item.desil[1]) || 0)
                );
                
                const chart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Desil 1 (Sangat Miskin)',
                                data: dataD1,
                                backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                borderColor: 'rgba(220, 53, 69, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Desil 2 (Miskin)',
                                data: dataD2,
                                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                                borderColor: 'rgba(255, 193, 7, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: ${context.raw.toLocaleString('id-ID')} KK`;
                                    },
                                    afterLabel: function(context) {
                                        if (context.datasetIndex === 1) { // Untuk dataset D2
                                            const dataIndex = context.dataIndex;
                                            const totalD12 = dataD12[dataIndex];
                                            return `Total D1+D2: ${totalD12.toLocaleString('id-ID')} KK`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Jumlah KK'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString('id-ID');
                                    }
                                }
                            },
                            y: {
                                ticks: {
                                    autoSkip: false,
                                    maxRotation: 0,
                                    minRotation: 0
                                }
                            }
                        }
                    }
                });
                chartInstances.push(chart2);
            }
        }

        // Fungsi untuk generate QR Code - DIPERBAIKI
        function generateQRCode() {
            const now = new Date();
            const totalD1D2 = cachedData.reduce((sum, item) => {
                return sum + (Number(item.desil[0]) || 0) + (Number(item.desil[1]) || 0);
            }, 0);
            
            const qrData = {
                dokumen: 'Laporan DTSEN Kecamatan Sumber',
                tanggal: now.toISOString(),
                total_wilayah: cachedData.length,
                total_prioritas: totalD1D2,
                penandatangan: 'SHIDIQ HASANUDIN, S.IP',
                id_dokumen: `DTSEN-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}`
            };
            
            const qrElement = document.getElementById('qrcodeTTD');
            if (qrElement && typeof QRCode !== 'undefined') {
                // Hapus QR code sebelumnya jika ada
                qrElement.innerHTML = '';
                
                // Pastikan elemen div kosong
                const container = document.createElement('div');
                qrElement.appendChild(container);
                
                // Generate QR code baru
                try {
                    new QRCode(container, {
                        text: JSON.stringify(qrData),
                        width: 110,
                        height: 110,
                        colorDark: '#000000',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    
                    console.log('QR Code generated successfully');
                } catch (error) {
                    console.error('Error generating QR code:', error);
                    qrElement.innerHTML = '<p class="text-danger small">QR Code gagal dibuat</p>';
                }
            } else {
                console.warn('QR Code element not found or QRCode library not loaded');
            }
        }

        // Fungsi untuk export PDF
        function exportPDF() {
            const element = document.getElementById('laporanContainer');
            const opt = {
                margin: [15, 15, 15, 15],
                filename: `Laporan_DTSEN_Kecamatan_Sumber_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: true
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait' 
                }
            };

            // Pastikan QR code sudah digenerate sebelum export
            setTimeout(() => {
                html2pdf().set(opt).from(element).save();
            }, 500);
        }

        // Inisialisasi saat halaman dimuat
        document.addEventListener('DOMContentLoaded', function() {
            loadDataFromFirebase();
            
            // Auto-refresh setiap 5 menit
            setInterval(loadDataFromFirebase, 5 * 60 * 1000);
        });

        // Export fungsi ke global scope
        window.generateLaporan = generateLaporan;
        window.exportPDF = exportPDF;
    </script>
</body>
</html>
