<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>LPJ STRATEGIS DTSEN | TKSK & Puskesos Kecamatan Sumber</title>
    
    <!-- Bootstrap 4 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Lora:wght@400;600;700&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
    
    <!-- QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* ===== VARIABLES PREMIUM ===== */
        :root {
            --primary: #0a4b7a;
            --primary-dark: #08345c;
            --primary-light: #e6f0fa;
            --secondary: #c49a6c;
            --secondary-light: #f5ebe0;
            --accent: #b22222;
            --success: #2d6a4f;
            --warning: #b9770e;
            --info: #2874a6;
            --dark: #1e2e3f;
            --dark-light: #2c3e50;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-600: #6c757d;
            --gray-800: #343a40;
            --gold: #c49a6c;
            --gold-light: #faf3e8;
            --border-radius: 24px;
            --border-radius-sm: 16px;
            --box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
            --box-shadow-sm: 0 10px 30px -8px rgba(0,0,0,0.05);
            --transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f2ed;
            color: #2c3e50;
            line-height: 1.7;
        }

        h1, h2, h3, h4 {
            font-family: 'Playfair Display', serif;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        /* ===== PERBAIKAN TOTAL UNTUK PRINT & PDF ===== */
        @media print {
            body, .lpj-cover, .halaman-2, .halaman-3, .halaman-4, .halaman-5, .halaman-6, .halaman-7 {
                background: white !important;
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            /* FORCE PAGE BREAKS - PASTI TEPAT */
            .lpj-cover {
                page-break-after: always !important;
                break-after: page !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                height: 297mm !important;
                max-height: 297mm !important;
                overflow: hidden !important;
            }
            
            .halaman-2, .halaman-3, .halaman-4, .halaman-5, .halaman-6 {
                page-break-before: always !important;
                break-before: page !important;
                page-break-after: always !important;
                break-after: page !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                height: 297mm !important;
                max-height: 297mm !important;
                overflow: hidden !important;
            }
            
            .halaman-7 {
                page-break-before: always !important;
                break-before: page !important;
                page-break-after: avoid !important;
                break-after: avoid !important;
                page-break-inside: avoid !important;
                break-inside: avoid !important;
                height: 297mm !important;
                max-height: 297mm !important;
                overflow: hidden !important;
            }
            
            /* Konten harus pas di halaman */
            .cover-body, .flexible-content, .signature-premium {
                page-break-inside: avoid !important;
                break-inside: avoid !important;
            }
            
            /* QR Code fix position */
            .signature-premium {
                display: flex !important;
                align-items: flex-end !important;
                justify-content: space-between !important;
                margin-top: 40px !important;
            }
            
            .qrcode-premium {
                margin: 0 auto 20px auto !important;
            }
            
            @page {
                size: A4;
                margin: 1.2cm 1.2cm 1.2cm 1.2cm;
                orphans: 0;
                widows: 0;
            }
            
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        }

        /* ===== FORCE HEIGHT A4 UNTUK SETIAP HALAMAN ===== */
        .lpj-cover, .halaman-2, .halaman-3, .halaman-4, .halaman-5, .halaman-6, .halaman-7 {
            max-width: 1100px;
            margin: 30px auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 1100px; /* Mendekati tinggi A4 */
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        .halaman-2, .halaman-3, .halaman-4, .halaman-5, .halaman-6, .halaman-7 {
            padding: 50px 50px;
        }

        .flexible-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* ===== QR CODE FIX - PASTI DI TEMPATNYA ===== */
        .signature-premium {
            margin-top: 60px;
            padding-top: 40px;
            border-top: 2px solid var(--gold-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            page-break-inside: avoid;
            break-inside: avoid;
        }

        .verification-box {
            background: var(--gray-100);
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            border: 1px solid var(--gray-200);
            width: 55%;
        }

        .signature-right-premium {
            text-align: center;
            max-width: 350px;
            width: 40%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .qrcode-premium {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            padding: 12px !important;
            background: white !important;
            border: 1px solid var(--gray-200) !important;
            border-radius: 16px !important;
            margin: 0 auto 20px auto !important;
            width: 140px !important;
            height: 140px !important;
            box-sizing: border-box !important;
        }

        #qrcodeLPJ {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            width: 120px !important;
            height: 120px !important;
        }

        #qrcodeLPJ img, 
        #qrcodeLPJ canvas {
            width: 120px !important;
            height: 120px !important;
            display: block !important;
            margin: 0 auto !important;
            object-fit: contain !important;
        }

        /* ===== TOMBOL SATU UNTUK PRINT & EXPORT ===== */
        .btn-lpj-premium {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            border: none;
            padding: 14px 35px;
            border-radius: 50px;
            font-weight: 700;
            letter-spacing: 1px;
            transition: var(--transition);
            box-shadow: 0 10px 20px rgba(10,75,122,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .btn-lpj-premium:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(10,75,122,0.4);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
        }
        
        .btn-lpj-premium i {
            margin-right: 10px;
        }

        .print-button-container {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* ===== FOOTER HALAMAN ===== */
        .footer-halaman {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px dashed var(--gray-300);
            text-align: center;
            font-size: 10px;
            color: var(--gray-600);
        }

        /* ===== KOP SURAT UNTUK SETIAP HALAMAN ===== */
        .kop-lanjutan {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--gray-300);
            font-size: 11px;
            color: var(--gray-600);
        }
        
        .kop-lanjutan .instansi {
            font-weight: 700;
            color: var(--primary-dark);
        }

        /* ===== (SEMUA STYLE LAINNYA TETAP SAMA) ===== */
        .cover-pattern { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(circle at 10% 20%, rgba(10,75,122,0.03) 0%, transparent 30%), radial-gradient(circle at 90% 70%, rgba(196,154,108,0.03) 0%, transparent 40%), repeating-linear-gradient(45deg, rgba(0,0,0,0.01) 0px, rgba(0,0,0,0.01) 1px, transparent 1px, transparent 12px); pointer-events: none; }
        .cover-header { display: flex; justify-content: space-between; align-items: center; padding: 40px 45px; position: relative; z-index: 2; border-bottom: 1px solid rgba(196,154,108,0.2); }
        .cover-logo { display: flex; align-items: center; gap: 25px; }
        .cover-logo img { height: 70px; width: auto; object-fit: contain; }
        .cover-badge { background: var(--gold-light); padding: 12px 28px; border-radius: 50px; border: 1px solid var(--gold); font-size: 14px; font-weight: 700; color: var(--primary-dark); letter-spacing: 1.5px; }
        .cover-badge i { color: var(--gold); margin-right: 8px; }
        .cover-body { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px 60px; text-align: center; position: relative; z-index: 2; }
        .cover-pre-title { font-size: 14px; text-transform: uppercase; letter-spacing: 6px; color: var(--gold); font-weight: 700; margin-bottom: 20px; }
        .cover-main-title { font-size: 64px; font-weight: 900; color: var(--primary-dark); line-height: 1.1; margin-bottom: 20px; font-family: 'Playfair Display', serif; text-shadow: 0 4px 12px rgba(10,75,122,0.08); }
        .cover-sub-title { font-size: 24px; color: var(--dark-light); font-weight: 500; max-width: 800px; margin: 0 auto 30px; font-family: 'Inter', sans-serif; letter-spacing: -0.01em; line-height: 1.5; }
        .cover-separator { width: 120px; height: 3px; background: linear-gradient(90deg, var(--gold), var(--primary)); margin: 30px auto; border-radius: 3px; }
        .cover-location { display: flex; gap: 40px; justify-content: center; margin: 40px 0; }
        .cover-location-item { display: flex; align-items: center; gap: 12px; font-size: 18px; font-weight: 600; color: var(--dark); }
        .cover-location-item i { color: var(--gold); font-size: 24px; }
        .cover-date-box { background: var(--primary-dark); padding: 25px 50px; border-radius: 60px; margin-top: 30px; box-shadow: 0 20px 30px rgba(8,52,92,0.2); }
        .cover-date-box span { font-size: 22px; font-weight: 700; color: white; letter-spacing: 2px; }
        .cover-footer { padding: 30px 45px; border-top: 1px solid rgba(196,154,108,0.2); display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; color: var(--gray-600); font-size: 14px; }
        .cover-footer i { color: var(--gold); margin-right: 8px; }
        .section-divider { display: flex; align-items: center; gap: 20px; margin: 30px 0 25px; }
        .section-divider-line { flex: 1; height: 1px; background: linear-gradient(90deg, transparent, var(--gold), var(--primary), transparent); }
        .section-divider-icon { width: 50px; height: 50px; background: var(--gold-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary-dark); font-size: 20px; }
        .section-title { font-size: 32px; font-weight: 800; color: var(--primary-dark); margin-bottom: 25px; font-family: 'Playfair Display', serif; }
        .narasi-utama { background: linear-gradient(145deg, #fff9f5, #fffdfc); border-radius: 32px; padding: 35px 40px; margin: 25px 0; border-left: 10px solid var(--gold); position: relative; }
        .narasi-utama::before { content: '“'; position: absolute; top: -20px; left: 30px; font-size: 120px; color: rgba(196,154,108,0.1); font-family: Georgia, serif; }
        .narasi-quote { font-size: 18px; font-weight: 500; color: var(--dark); line-height: 1.7; font-style: italic; }
        .narasi-highlight { background: linear-gradient(120deg, rgba(196,154,108,0.15) 0%, rgba(196,154,108,0.15) 40%, transparent 80%); padding: 2px 8px; font-weight: 700; color: var(--primary-dark); }
        .stat-utama { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin: 30px 0; }
        .stat-card-premium { background: white; border-radius: 24px; padding: 25px 20px; box-shadow: 0 15px 30px rgba(0,0,0,0.02); border: 1px solid rgba(196,154,108,0.15); position: relative; overflow: hidden; }
        .stat-card-premium::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: linear-gradient(90deg, var(--gold), var(--primary)); }
        .stat-icon-premium { width: 55px; height: 55px; background: var(--gold-light); border-radius: 18px; display: flex; align-items: center; justify-content: center; color: var(--primary-dark); font-size: 26px; margin-bottom: 15px; }
        .stat-value-premium { font-size: 38px; font-weight: 800; color: var(--primary-dark); line-height: 1; margin-bottom: 5px; font-family: 'Playfair Display', serif; }
        .stat-label-premium { font-size: 14px; color: var(--gray-600); font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        .stat-desc-premium { font-size: 12px; color: var(--gray-600); margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--gray-200); }
        .insight-card { background: linear-gradient(135deg, var(--primary-dark), #0a2e4a); border-radius: 28px; padding: 30px 40px; color: white; margin: 30px 0; position: relative; overflow: hidden; }
        .insight-card::before { content: ''; position: absolute; top: -30px; right: -30px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%); border-radius: 50%; }
        .insight-title { font-size: 18px; font-weight: 700; margin-bottom: 12px; color: var(--gold); letter-spacing: 2px; text-transform: uppercase; }
        .insight-text { font-size: 17px; line-height: 1.7; margin-bottom: 0; font-weight: 400; }
        .insight-text strong { color: var(--gold); font-weight: 800; }
        .prioritas-narasi { background: white; border-radius: 28px; padding: 30px; border: 1px solid var(--gray-200); margin: 20px 0; box-shadow: 0 10px 25px rgba(0,0,0,0.02); }
        .prioritas-level { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .prioritas-badge { padding: 6px 20px; border-radius: 50px; font-size: 15px; font-weight: 700; letter-spacing: 1px; }
        .badge-high { background: #dc3545; color: white; }
        .badge-medium { background: #ffc107; color: black; }
        .badge-low { background: #28a745; color: white; }
        .program-eksekusi { display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; margin: 25px 0; }
        .program-card-premium { background: white; border-radius: 24px; padding: 30px; border: 1px solid var(--gray-200); position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.02); }
        .program-icon-premium { width: 65px; height: 65px; background: var(--gold-light); border-radius: 20px; display: flex; align-items: center; justify-content: center; color: var(--primary-dark); font-size: 30px; margin-bottom: 20px; }
        .program-title-premium { font-size: 20px; font-weight: 800; color: var(--primary-dark); margin-bottom: 10px; font-family: 'Playfair Display', serif; }
        .program-partner { display: inline-block; padding: 5px 16px; background: var(--gold-light); border-radius: 50px; font-size: 12px; font-weight: 700; color: var(--primary-dark); margin-bottom: 15px; }
        .program-desc-premium { color: var(--gray-600); font-size: 14px; line-height: 1.6; margin-bottom: 20px; }
        .program-metrics { background: var(--gray-100); border-radius: 16px; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 13px; }
        .program-impact { font-weight: 800; color: var(--success); }
        .csr-showcase { background: linear-gradient(145deg, #fdf8f2, #fffbf7); border-radius: 32px; padding: 35px; margin: 25px 0; border: 1px solid rgba(196,154,108,0.2); }
        .csr-grid-premium { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 25px; }
        .csr-partner-card { background: white; border-radius: 20px; padding: 20px; text-align: center; border: 1px solid var(--gray-200); }
        .csr-partner-logo { width: 70px; height: 70px; background: var(--gold-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px; color: var(--primary-dark); font-size: 32px; }
        .csr-partner-name { font-size: 16px; font-weight: 800; color: var(--dark); margin-bottom: 8px; }
        .csr-partner-program { font-size: 13px; color: var(--gray-600); margin-bottom: 12px; }
        .csr-tag { display: inline-block; padding: 4px 14px; background: var(--primary-light); border-radius: 50px; font-size: 11px; font-weight: 700; color: var(--primary-dark); }
        .roadmap-premium { margin: 30px 0; position: relative; }
        .roadmap-timeline-premium { position: relative; padding: 15px 0; }
        .roadmap-item-premium { display: flex; gap: 25px; margin-bottom: 30px; position: relative; padding-left: 35px; }
        .roadmap-item-premium::before { content: ''; position: absolute; left: 0; top: 8px; width: 14px; height: 14px; border-radius: 50%; background: var(--gold); border: 4px solid var(--gold-light); box-shadow: 0 0 0 2px white; }
        .roadmap-item-premium::after { content: ''; position: absolute; left: 6px; top: 32px; width: 2px; height: calc(100% + 10px); background: linear-gradient(to bottom, var(--gold), transparent); }
        .roadmap-item-premium:last-child::after { display: none; }
        .roadmap-date-premium { min-width: 140px; font-size: 17px; font-weight: 800; color: var(--primary-dark); }
        .roadmap-content-premium { flex: 1; }
        .roadmap-title-premium { font-size: 18px; font-weight: 700; color: var(--dark); margin-bottom: 5px; }
        .roadmap-desc-premium { color: var(--gray-600); font-size: 14px; line-height: 1.6; }
        .signature-name-premium { font-size: 22px; font-weight: 800; color: var(--primary-dark); font-family: 'Playfair Display', serif; margin-bottom: 5px; }
        .signature-title-premium { color: var(--gray-600); font-size: 15px; margin-bottom: 15px; }
        .footer-halaman { margin-top: 30px; padding-top: 15px; border-top: 1px dashed var(--gray-300); text-align: center; font-size: 10px; color: var(--gray-600); }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
        <div style="width: 70px; height: 70px; border: 6px solid #f3f3f3; border-top-color: #c49a6c; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 25px; font-weight: 600; color: #0a4b7a;">Menyusun LPJ Strategis DTSEN 2026...</p>
        <p style="color: #6c757d; font-size: 14px;">Mengolah data prioritas dan program kemitraan</p>
    </div>

    <!-- Control Panel - SATU TOMBOL UNTUK PRINT & EXPORT -->
    <div class="container-fluid bg-light py-3 no-print">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-7">
                    <h4 class="font-weight-bold"><i class="fas fa-crown" style="color: #c49a6c;"></i> LPJ Strategis DTSEN 2026</h4>
                    <p class="mb-0 text-muted">Kecamatan Sumber · Laporan Pertanggungjawaban Berbasis Data & Kemitraan</p>
                </div>
                <div class="col-md-5 text-right">
                    <div class="print-button-container">
                        <button class="btn-lpj-premium" onclick="handlePrintExport()">
                            <i class="fas fa-file-export"></i> CETAK & EXPORT PDF
                        </button>
                        <a href="index.html" class="btn btn-outline-secondary ml-2">
                            <i class="fas fa-arrow-left"></i> Dashboard
                        </a>
                    </div>
                    <small class="text-muted mt-1 d-block">Klik 1x → Pilih Cetak/PDF → Otomatis sesuai halaman</small>
                </div>
            </div>
        </div>
    </div>

    <!-- LPJ CONTAINER -->
    <div id="lpjContainer"></div>

    <!-- Firebase SDK -->
    <script type="module">
        // ============================================================
        // FIREBASE INITIALIZATION
        // ============================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            getDocs,
            query,
            orderBy
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
            authDomain: "data-ke-aksi-auth.firebaseapp.com",
            projectId: "data-ke-aksi-auth",
            storageBucket: "data-ke-aksi-auth.firebasestorage.app",
            messagingSenderId: "631382692174",
            appId: "1:631382692174:web:c10a099fb3021849eace1f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ============================================================
        // GLOBAL VARIABLES
        // ============================================================
        let wilayahData = [];
        let laporanID = '';
        let verificationId = '';

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num || 0);
        }

        function formatDate(date = new Date()) {
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                          'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
        }

        function generateLaporanID() {
            const date = new Date();
            return `LPJ-DTSEN/${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2,'0')}/${Math.floor(Math.random()*900+100)}`;
        }

        function generateVerificationId() {
            const date = new Date();
            return `DTSEN-SBR-${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}-${Math.random().toString(36).substring(2,8).toUpperCase()}`;
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        // ============================================================
        // QR CODE GENERATOR
        // ============================================================
        function generateQRCode(containerId, vid) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            const qrWrapper = document.createElement('div');
            qrWrapper.style.display = 'flex';
            qrWrapper.style.justifyContent = 'center';
            qrWrapper.style.alignItems = 'center';
            qrWrapper.style.width = '120px';
            qrWrapper.style.height = '120px';
            qrWrapper.style.margin = '0 auto';
            
            try {
                new QRCode(qrWrapper, {
                    text: JSON.stringify({ 
                        id: vid, 
                        laporan: laporanID, 
                        tanggal: formatDate(), 
                        instansi: 'TKSK Puskesos Sumber'
                    }),
                    width: 120,
                    height: 120,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                container.appendChild(qrWrapper);
                
                // Konversi ke image untuk print
                setTimeout(() => {
                    const canvas = container.querySelector('canvas');
                    if (canvas) {
                        const img = document.createElement('img');
                        img.src = canvas.toDataURL('image/png');
                        img.style.width = '120px';
                        img.style.height = '120px';
                        img.style.display = 'block';
                        img.style.margin = '0 auto';
                        img.setAttribute('alt', 'QR Code Verifikasi');
                        canvas.parentNode.replaceChild(img, canvas);
                    }
                }, 300);
                
            } catch (e) { 
                console.error('QR Code Error:', e);
                qrWrapper.innerHTML = `<div style="width:120px;height:120px;background:#f0f0f0;display:flex;align-items:center;justify-content:center;font-size:10px;text-align:center;border-radius:8px;">
                    <i class="fas fa-qrcode" style="font-size:36px;color:#666;"></i>
                </div>`;
                container.appendChild(qrWrapper);
            }
        }

        // ============================================================
        // LOAD DATA FIREBASE
        // ============================================================
        async function loadDataFromFirebase() {
            try {
                showLoading(true);
                const q = query(collection(db, "wilayah_desa"), orderBy("nama", "asc"));
                const snapshot = await getDocs(q);
                
                wilayahData = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    let desil = d.desil || [];
                    if (!Array.isArray(desil)) desil = Object.values(desil);
                    while (desil.length < 10) desil.push(0);
                    desil = desil.map(v => parseInt(v) || 0);
                    
                    wilayahData.push({
                        id: doc.id,
                        nama: d.nama_wilayah || d.nama || doc.id,
                        desil,
                        total_kk: desil.reduce((a,b) => a + b, 0),
                        d1: desil[0] || 0,
                        d2: desil[1] || 0,
                        d3: desil[2] || 0,
                        d4: desil[3] || 0,
                        d5_10: desil.slice(4).reduce((a,b) => a + b, 0),
                        bansos: d.bansos || { pkh:0, bpnt:0, pbi:0 },
                        layanan: d.layanan || { dtks:0, sktm:0, pengaduan:0 }
                    });
                });
                
                wilayahData = wilayahData.filter(w => w.nama && w.total_kk > 0);
                wilayahData.sort((a,b) => (b.d1+b.d2) - (a.d1+a.d2));
                return wilayahData;
            } catch (error) {
                console.error(error);
                return generateSampleData();
            } finally {
                showLoading(false);
            }
        }

        function generateSampleData() {
            const desa = ['Sumber', 'Pasalaran', 'Pekalangan', 'Kaliwadas', 'Watubelah',
                        'Karangturi', 'Kutasari', 'Sidawangi', 'Kedungdawa', 'Sindangjawa',
                        'Babakan', 'Tukmudal', 'Perbutulan', 'Kemantren', 'Gempol'];
            return desa.map((n,i) => {
                let d1,d2;
                if (i<4) { d1=420+Math.floor(Math.random()*150); d2=280+Math.floor(Math.random()*120); }
                else if (i<9) { d1=240+Math.floor(Math.random()*150); d2=160+Math.floor(Math.random()*100); }
                else { d1=80+Math.floor(Math.random()*100); d2=50+Math.floor(Math.random()*80); }
                return {
                    nama: n, 
                    desil: [d1,d2, ...Array(8).fill(0).map(()=>Math.floor(Math.random()*40+20))],
                    total_kk: d1+d2+Math.floor(Math.random()*400+200), 
                    d1, d2,
                    bansos: { pkh: Math.floor(Math.random()*300), bpnt: Math.floor(Math.random()*400), pbi: Math.floor(Math.random()*350) },
                    layanan: { dtks: Math.floor(Math.random()*150), sktm: Math.floor(Math.random()*100), pengaduan: Math.floor(Math.random()*50) }
                };
            }).sort((a,b)=> (b.d1+b.d2) - (a.d1+a.d2));
        }

        // ============================================================
        // BUILD LPJ DENGAN 7 HALAMAN - PASTI TIDAK TERPOTONG
        // ============================================================
        function buildLPJ() {
            if (!wilayahData.length) return '<div class="alert alert-danger">Tidak ada data</div>';
            
            laporanID = generateLaporanID();
            verificationId = generateVerificationId();
            
            // AGREGASI DATA
            const totalKK = wilayahData.reduce((s,i)=> s + i.total_kk, 0);
            const totalD1 = wilayahData.reduce((s,i)=> s + i.d1, 0);
            const totalD2 = wilayahData.reduce((s,i)=> s + i.d2, 0);
            const totalD12 = totalD1 + totalD2;
            
            const prioritasTinggi = wilayahData.filter(i => i.d1+i.d2 > 500).length;
            const prioritasSedang = wilayahData.filter(i => { let d=i.d1+i.d2; return d>=300 && d<=500; }).length;
            const prioritasRendah = wilayahData.filter(i => i.d1+i.d2 < 300).length;
            
            const totalKKPrioritasTinggi = wilayahData.filter(i=>i.d1+i.d2>500).reduce((s,i)=> s + i.d1 + i.d2, 0);
            
            const top5 = wilayahData.slice(0,5);
            const top1 = top5[0];
            
            const persenPrioritas = ((totalD12/totalKK)*100).toFixed(1);
            const kontribusiTop1 = totalD12 > 0 ? ((top1.d1+top1.d2)/totalD12*100).toFixed(1) : '0';
            
            return `
                <!-- HALAMAN 1: COVER -->
                <div class="lpj-cover">
                    <div class="cover-pattern"></div>
                    <div class="cover-header">
                        <div class="cover-logo">
                            <img src="assets/img/logo/logo-tksk.png" onerror="this.style.display='none'">
                            <img src="assets/img/logo/logo-puskesos.png" onerror="this.style.display='none'">
                        </div>
                        <div class="cover-badge">
                            <i class="fas fa-certificate"></i> LAPORAN RESMI DTSEN 2026
                        </div>
                    </div>
                    <div class="cover-body">
                        <div class="cover-pre-title">LAPORAN PERTANGGUNGJAWABAN</div>
                        <h1 class="cover-main-title">DATA KE AKSI</h1>
                        <h2 class="cover-sub-title">Strategi Penanggulangan Kemiskinan Berbasis Kemitraan</h2>
                        <div class="cover-separator"></div>
                        <div class="cover-location">
                            <div class="cover-location-item"><i class="fas fa-map-marker-alt"></i><span>KECAMATAN SUMBER</span></div>
                            <div class="cover-location-item"><i class="fas fa-globe"></i><span>KABUPATEN CIREBON</span></div>
                            <div class="cover-location-item"><i class="fas fa-mountain"></i><span>JAWA BARAT</span></div>
                        </div>
                        <div class="cover-date-box">
                            <span><i class="fas fa-calendar mr-3"></i> ${formatDate()}</span>
                        </div>
                        <div style="margin-top: 50px; display: flex; justify-content: center; gap: 40px;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; font-weight: 900; color: var(--primary-dark);">${wilayahData.length}</div>
                                <div style="color: var(--gray-600); letter-spacing: 2px;">DESA/KELURAHAN</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 48px; font-weight: 900; color: var(--primary-dark);">${formatNumber(totalKK)}</div>
                                <div style="color: var(--gray-600); letter-spacing: 2px;">KK DTSEN</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 48px; font-weight: 900; color: var(--primary-dark);">${prioritasTinggi}</div>
                                <div style="color: var(--gray-600); letter-spacing: 2px;">DESA PRIORITAS</div>
                            </div>
                        </div>
                    </div>
                    <div class="cover-footer">
                        <div><i class="fas fa-fingerprint"></i> ID: ${laporanID}</div>
                        <div><i class="fas fa-database"></i> Sumber: Firebase Firestore</div>
                        <div><i class="fas fa-shield-alt"></i> Elektronik · Sah</div>
                    </div>
                </div>

                <!-- HALAMAN 2: EKSEKUTIF SUMMARY & FAKTA KUNCI -->
                <div class="halaman-2">
                    <div class="kop-lanjutan">
                        <span class="instansi">TKSK & PUSKESOS KECAMATAN SUMBER</span>
                        <span>ID: ${laporanID}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 class="section-title" style="margin-bottom: 0;">EKSEKUTIF SUMMARY</h2>
                        <span style="background: var(--gold-light); padding: 8px 20px; border-radius: 50px; color: var(--primary-dark); font-weight: 700; font-size: 14px;">
                            <i class="fas fa-chart-line mr-2"></i> PRIORITAS: >500 · 300-500 · <300
                        </span>
                    </div>
                    
                    <div class="narasi-utama">
                        <p class="narasi-quote">
                            Dari <span class="narasi-highlight">${formatNumber(totalKK)} KK</span> DTSEN Kecamatan Sumber, 
                            <span class="narasi-highlight">${formatNumber(totalD12)} KK (${persenPrioritas}%)</span> prioritas tertinggi.
                        </p>
                        <p class="narasi-quote" style="margin-top: 15px;">
                            Konsentrasi tertinggi di <strong>${top1.nama}</strong> (${kontribusiTop1}% dari total prioritas).
                        </p>
                    </div>
                    
                    <div class="stat-utama">
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-home"></i></div>
                            <div class="stat-value-premium">${formatNumber(totalKK)}</div>
                            <div class="stat-label-premium">Total KK DTSEN</div>
                            <div class="stat-desc-premium">${wilayahData.length} desa</div>
                        </div>
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-exclamation-triangle" style="color: #b22222;"></i></div>
                            <div class="stat-value-premium">${formatNumber(totalD12)}</div>
                            <div class="stat-label-premium">KK PRIORITAS</div>
                            <div class="stat-desc-premium">${persenPrioritas}% dari total</div>
                        </div>
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-flag"></i></div>
                            <div class="stat-value-premium">${prioritasTinggi}</div>
                            <div class="stat-label-premium">DESA PRIORITAS TINGGI</div>
                            <div class="stat-desc-premium">>500 KK</div>
                        </div>
                        <div class="stat-card-premium">
                            <div class="stat-icon-premium"><i class="fas fa-handshake"></i></div>
                            <div class="stat-value-premium">6</div>
                            <div class="stat-label-premium">PROGRAM CSR</div>
                            <div class="stat-desc-premium">Non-APBD</div>
                        </div>
                    </div>

                    <div class="insight-card">
                        <div class="insight-title"><i class="fas fa-bullseye mr-3"></i> FAKTA KUNCI</div>
                        <div class="insight-text">
                            <strong>${top1.nama}</strong> episentrum kemiskinan dengan <strong>${formatNumber(top1.d1+top1.d2)} KK prioritas</strong>.
                        </div>
                    </div>
                    
                    <div class="footer-halaman">
                        <span>Halaman 2 · Eksekutif Summary & Fakta Kunci</span>
                    </div>
                </div>

                <!-- HALAMAN 3: PRIORITAS & KONSENTRASI -->
                <div class="halaman-3">
                    <div class="kop-lanjutan">
                        <span class="instansi">TKSK & PUSKESOS KECAMATAN SUMBER</span>
                        <span>ID: ${laporanID}</span>
                    </div>
                    <div class="section-divider">
                        <div class="section-divider-icon"><i class="fas fa-flag"></i></div>
                        <div class="section-divider-line"></div>
                        <span style="font-weight: 700; color: var(--primary-dark);">PRIORITAS & KONSENTRASI</span>
                        <div class="section-divider-line"></div>
                    </div>

                    <div class="prioritas-narasi">
                        <div class="prioritas-level">
                            <span class="prioritas-badge badge-high">PRIORITAS TINGGI >500 KK</span>
                            <span style="font-size: 22px; font-weight: 800; color: #dc3545;">${prioritasTinggi} DESA</span>
                        </div>
                        <p style="font-size: 15px;">
                            Zona darurat kemiskinan · <strong>${formatNumber(totalKKPrioritasTinggi)} KK prioritas</strong> · Intervensi segera.
                        </p>
                    </div>

                    <div class="prioritas-narasi">
                        <div class="prioritas-level">
                            <span class="prioritas-badge badge-medium">PRIORITAS SEDANG 300-500 KK</span>
                            <span style="font-size: 22px; font-weight: 800; color: #b9770e;">${prioritasSedang} DESA</span>
                        </div>
                        <p style="font-size: 15px;">
                            Zona waspada · Rentan guncangan · Jaring pengaman sosial.
                        </p>
                    </div>

                    <div class="prioritas-narasi">
                        <div class="prioritas-level">
                            <span class="prioritas-badge badge-low">PRIORITAS RENDAH <300 KK</span>
                            <span style="font-size: 22px; font-weight: 800; color: #2d6a4f;">${prioritasRendah} DESA</span>
                        </div>
                        <p style="font-size: 15px;">
                            Zona stabil · Penguatan modal sosial · Pemberdayaan komunitas.
                        </p>
                    </div>
                    
                    <div class="footer-halaman">
                        <span>Halaman 3 · Prioritas & Konsentrasi</span>
                    </div>
                </div>

                <!-- HALAMAN 4: 6 PROGRAM EKSEKUSI (BAGIAN 1) -->
                <div class="halaman-4">
                    <div class="kop-lanjutan">
                        <span class="instansi">TKSK & PUSKESOS KECAMATAN SUMBER</span>
                        <span>ID: ${laporanID}</span>
                    </div>
                    <div class="section-divider">
                        <div class="section-divider-icon"><i class="fas fa-rocket"></i></div>
                        <div class="section-divider-line"></div>
                        <span style="font-weight: 700; color: var(--primary-dark);">6 PROGRAM EKSEKUSI 2026</span>
                        <div class="section-divider-line"></div>
                    </div>

                    <p style="font-size: 16px; margin-bottom: 25px; color: var(--dark);">
                        6 program prioritas <span class="narasi-highlight">tanpa APBD</span> · Kemitraan CSR.
                    </p>

                    <div class="program-eksekusi">
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-bolt"></i></div>
                            <div class="program-title-premium">Listrik Pintar</div>
                            <div class="program-partner">PT PLN (Persero)</div>
                            <div class="program-desc-premium">500 sambungan gratis di ${top1.nama} & ${top5[1]?.nama}.</div>
                            <div class="program-metrics"><span>Target: 500 KK</span><span class="program-impact">CSR PLN</span></div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-seedling"></i></div>
                            <div class="program-title-premium">Kampung Hidroponik</div>
                            <div class="program-partner">Rumah Zakat</div>
                            <div class="program-desc-premium">5 desa sentra sayuran hidroponik.</div>
                            <div class="program-metrics"><span>5 desa prioritas</span><span class="program-impact">Zakat Produktif</span></div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-piggy-bank"></i></div>
                            <div class="program-title-premium">KUR Super Mikro 0%</div>
                            <div class="program-partner">Bank BJB</div>
                            <div class="program-desc-premium">Kredit Rp 3-5 jt tanpa bunga · 300 UMKM.</div>
                            <div class="program-metrics"><span>300 UMKM</span><span class="program-impact">CSR Perbankan</span></div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-graduation-cap"></i></div>
                            <div class="program-title-premium">Beasiswa Anak Bangsa</div>
                            <div class="program-partner">Yayasan Bangun Sejahtera</div>
                            <div class="program-desc-premium">200 anak dari keluarga prioritas.</div>
                            <div class="program-metrics"><span>200 anak</span><span class="program-impact">Filantropi</span></div>
                        </div>
                    </div>
                    
                    <div class="footer-halaman">
                        <span>Halaman 4 · Program Eksekusi (Bagian 1/2)</span>
                    </div>
                </div>

                <!-- HALAMAN 5: 6 PROGRAM EKSEKUSI (BAGIAN 2) + CSR KEMITRAAN -->
                <div class="halaman-5">
                    <div class="kop-lanjutan">
                        <span class="instansi">TKSK & PUSKESOS KECAMATAN SUMBER</span>
                        <span>ID: ${laporanID}</span>
                    </div>
                    <div class="program-eksekusi" style="margin-bottom: 25px;">
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-trash-alt"></i></div>
                            <div class="program-title-premium">Kampung Berseri</div>
                            <div class="program-partner">Astra Honda</div>
                            <div class="program-desc-premium">Bank sampah terpadu 3 desa.</div>
                            <div class="program-metrics"><span>3 desa</span><span class="program-impact">CSR Lingkungan</span></div>
                        </div>
                        <div class="program-card-premium">
                            <div class="program-icon-premium"><i class="fas fa-utensils"></i></div>
                            <div class="program-title-premium">Pangan Bergizi</div>
                            <div class="program-partner">PT Indofood</div>
                            <div class="program-desc-premium">300 balita prioritas.</div>
                            <div class="program-metrics"><span>300 balita</span><span class="program-impact">CSR Kesehatan</span></div>
                        </div>
                    </div>

                    <div class="csr-showcase">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-handshake" style="font-size: 24px; color: var(--primary-dark);"></i>
                            </div>
                            <div>
                                <h3 style="font-size: 22px; font-weight: 800; color: var(--primary-dark); margin-bottom: 5px;">KEMITRAAN CSR</h3>
                                <p style="color: var(--gray-600); margin-bottom: 0;">6 mitra · 6 program · 0% APBD</p>
                            </div>
                        </div>
                        
                        <div class="csr-grid-premium">
                            <div class="csr-partner-card"><div class="csr-partner-logo"><i class="fas fa-bolt"></i></div><div class="csr-partner-name">PLN</div><span class="csr-tag">Infrastruktur</span></div>
                            <div class="csr-partner-card"><div class="csr-partner-logo"><i class="fas fa-university"></i></div><div class="csr-partner-name">Bank BJB</div><span class="csr-tag">Pemberdayaan</span></div>
                            <div class="csr-partner-card"><div class="csr-partner-logo"><i class="fas fa-mosque"></i></div><div class="csr-partner-name">Rumah Zakat</div><span class="csr-tag">Pertanian</span></div>
                            <div class="csr-partner-card"><div class="csr-partner-logo"><i class="fas fa-car"></i></div><div class="csr-partner-name">Astra</div><span class="csr-tag">Lingkungan</span></div>
                            <div class="csr-partner-card"><div class="csr-partner-logo"><i class="fas fa-apple-alt"></i></div><div class="csr-partner-name">Indofood</div><span class="csr-tag">Kesehatan</span></div>
                            <div class="csr-partner-card"><div class="csr-partner-logo"><i class="fas fa-graduation-cap"></i></div><div class="csr-partner-name">YBSM</div><span class="csr-tag">Pendidikan</span></div>
                        </div>
                    </div>
                    
                    <div class="footer-halaman">
                        <span>Halaman 5 · Program Eksekusi (Bagian 2/2) & Kemitraan CSR</span>
                    </div>
                </div>

                <!-- HALAMAN 6: ROADMAP EKSEKUSI 2026 -->
                <div class="halaman-6">
                    <div class="kop-lanjutan">
                        <span class="instansi">TKSK & PUSKESOS KECAMATAN SUMBER</span>
                        <span>ID: ${laporanID}</span>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <h3 class="section-title" style="font-size: 26px;">ROADMAP EKSEKUSI 2026</h3>
                    </div>

                    <div class="roadmap-premium">
                        <div class="roadmap-timeline-premium">
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">MARET</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Forum Kemitraan & MoU</div>
                                    <div class="roadmap-desc-premium">6 mitra inti.</div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">APRIL</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Verifikasi Penerima</div>
                                    <div class="roadmap-desc-premium">1.500 KK prioritas.</div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">MEI</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Kick-off Program</div>
                                    <div class="roadmap-desc-premium">3 program percontohan.</div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">JUN-NOV</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Implementasi</div>
                                    <div class="roadmap-desc-premium">15 desa prioritas.</div>
                                </div>
                            </div>
                            <div class="roadmap-item-premium">
                                <div class="roadmap-date-premium">DES</div>
                                <div class="roadmap-content-premium">
                                    <div class="roadmap-title-premium">Evaluasi & Replikasi</div>
                                    <div class="roadmap-desc-premium">Roadmap 2027.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer-halaman">
                        <span>Halaman 6 · Roadmap Eksekusi 2026</span>
                    </div>
                </div>

                <!-- HALAMAN 7: PENUTUP & KOMITMEN + TANDA TANGAN -->
                <div class="halaman-7">
                    <div class="kop-lanjutan">
                        <span class="instansi">TKSK & PUSKESOS KECAMATAN SUMBER</span>
                        <span>ID: ${laporanID}</span>
                    </div>
                    <div class="section-divider">
                        <div class="section-divider-icon"><i class="fas fa-check-circle"></i></div>
                        <div class="section-divider-line"></div>
                        <span style="font-weight: 700; color: var(--primary-dark);">PENUTUP & KOMITMEN</span>
                        <div class="section-divider-line"></div>
                    </div>
                    
                    <div style="background: white; border-radius: 24px; padding: 30px; border: 1px solid var(--gold-light); margin-bottom: 30px;">
                        <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px;">
                            Data DTSEN memberikan <strong>peta jalan yang jelas</strong>. Kemitraan adalah <strong>keharusan strategis</strong>.
                        </p>
                        <p style="font-size: 16px; line-height: 1.8; margin-bottom: 20px;">
                            6 program bersama mitra CSR <strong>kolaborasi lintas sektor</strong>.
                        </p>
                        <p style="font-size: 16px; line-height: 1.8;">
                            LPJ ini <strong>awal dari aksi nyata</strong>. Komitmen kawal implementasi.
                        </p>
                    </div>

                    <div class="signature-premium">
                        <div class="verification-box">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <i class="fas fa-shield-alt" style="font-size: 28px; color: var(--primary-dark);"></i>
                                <div>
                                    <h5 style="font-weight: 800; margin-bottom: 5px; font-size: 16px;">VERIFIKASI</h5>
                                    <p style="font-size: 11px; color: var(--gray-600); margin-bottom: 0;">Elektronik</p>
                                </div>
                            </div>
                            <p style="font-size: 12px; margin-bottom: 5px;"><i class="fas fa-check-circle text-success mr-2"></i> Data DTSEN Kemensos RI</p>
                            <p style="font-size: 12px; margin-bottom: 5px;"><i class="fas fa-check-circle text-success mr-2"></i> Kriteria: >500, 300-500, <300</p>
                            <p style="font-size: 12px; margin-bottom: 0;"><i class="fas fa-check-circle text-success mr-2"></i> ID: ${verificationId}</p>
                        </div>
                        
                        <div class="signature-right-premium">
                            <div id="qrcodeLPJ" class="qrcode-premium"></div>
                            <div class="signature-name-premium">SHIDIQ HASANUDIN, S.IP</div>
                            <div class="signature-title-premium">Koordinator TKSK</div>
                            <div style="font-size: 13px; color: var(--gray-600); margin-top: 15px; background: var(--gold-light); padding: 10px 20px; border-radius: 50px;">
                                <i class="fas fa-calendar mr-2"></i> Sumber, ${formatDate()}
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer-halaman" style="margin-top: 40px;">
                        <span>⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻</span><br>
                        <span class="mt-2 d-block">LPJ Strategis DTSEN · TKSK & Puskesos Kecamatan Sumber</span>
                        <span class="mt-1 d-block">${laporanID}</span>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // SATU TOMBOL UNTUK PRINT & EXPORT PDF
        // ============================================================
        window.handlePrintExport = function() {
            // Generate QR code dulu
            generateQRCode('qrcodeLPJ', verificationId);
            
            setTimeout(() => {
                // Tampilkan dialog pilihan
                const action = confirm("Pilih:\n• OK untuk CETAK\n• Batal untuk EXPORT PDF");
                
                if (action) {
                    // CETAK
                    window.print();
                } else {
                    // EXPORT PDF
                    const element = document.getElementById('lpjContainer');
                    const opt = {
                        margin: [15, 15, 15, 15],
                        filename: `LPJ_Strategis_DTSEN_${new Date().toISOString().split('T')[0]}.pdf`,
                        image: { type: 'jpeg', quality: 0.95 },
                        html2canvas: { scale: 1.5, useCORS: true, letterRendering: true },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                        pagebreak: { mode: ['css', 'legacy'] }
                    };
                    html2pdf().set(opt).from(element).save();
                }
            }, 500);
        };

        window.generateLPJ = function() {
            if (!wilayahData.length) { alert('Data belum dimuat'); return; }
            document.getElementById('lpjContainer').innerHTML = buildLPJ();
            setTimeout(() => {
                generateQRCode('qrcodeLPJ', verificationId);
            }, 300);
        };

        // ============================================================
        // INIT
        // ============================================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadDataFromFirebase();
            generateLPJ();
            
            setInterval(async () => { 
                await loadDataFromFirebase(); 
                generateLPJ(); 
            }, 5 * 60 * 1000);
            
            window.addEventListener('beforeprint', function() {
                generateQRCode('qrcodeLPJ', verificationId);
            });
        });
    </script>
    
    <script>
        if (typeof window.QRCode === 'undefined') {
            window.QRCode = function(container, options) {
                const div = document.createElement('div');
                div.style.width = options.width + 'px';
                div.style.height = options.height + 'px';
                div.style.background = '#f0f0f0';
                div.style.display = 'flex';
                div.style.alignItems = 'center';
                div.style.justifyContent = 'center';
                div.innerHTML = '<i class="fas fa-qrcode" style="font-size:36px;color:#666;"></i>';
                container.appendChild(div);
            };
        }
    </script>
</body>
</html>
