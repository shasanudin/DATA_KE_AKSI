<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Arsip & Backup Data DTSEN | TKSK Kec. Sumber</title>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

  <style>
    :root {
      --primary: #007bff;
      --secondary: #0056b3;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --dark-bg: #1a1d20;
    }

    body { 
      font-family: 'Inter', sans-serif; 
      background-color: #f8f9fa; 
      color: #333; 
    }

    /* Hero Header Style */
    .archive-hero {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      padding: 60px 0;
      border-radius: 0 0 30px 30px;
      margin-bottom: 40px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Card Archive Style */
    .card-archive {
      border: none;
      border-radius: 15px;
      background: white;
      transition: all 0.3s ease;
      border-left: 5px solid transparent;
    }
    .card-archive:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      border-left-color: var(--primary);
    }

    .icon-box {
      width: 50px;
      height: 50px;
      background: #eef4ff;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 20px;
    }

    .btn-download {
      border-radius: 10px;
      font-weight: 600;
      padding: 8px 16px;
      transition: all 0.2s;
    }

    .btn-download:hover {
      background-color: #218838;
      color: white;
    }

    .btn-backup {
      border-radius: 50px;
      padding: 12px 30px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .status-badge {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border-radius: 50px;
      padding: 10px 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 10px;
      border-left: 4px solid var(--success);
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }

    .status-dot.online { background: #28a745; box-shadow: 0 0 10px rgba(40,167,69,0.5); animation: pulse 2s infinite; }
    .status-dot.offline { background: #dc3545; box-shadow: 0 0 10px rgba(220,53,69,0.5); }
    .status-dot.backup { background: #ffc107; box-shadow: 0 0 10px rgba(255,193,7,0.5); animation: pulse 1s infinite; }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .progress-custom {
      height: 8px;
      border-radius: 4px;
      background: #e9ecef;
      overflow: hidden;
    }

    .progress-bar-custom {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transition: width 0.3s ease;
    }

    footer { 
      background: var(--dark-bg); 
      color: #999; 
    }
  </style>
</head>
<body>

<div id="navbar"></div>

<!-- Status Connection & Backup -->
<div id="statusBadge" class="status-badge">
  <span class="status-dot offline" id="statusDot"></span>
  <span id="statusText">Menghubungkan ke Firebase...</span>
  <span class="ml-2 small text-muted" id="dataCount"></span>
</div>

<section class="archive-hero">
  <div class="container text-center">
    <h1 class="display-4 font-weight-bold">Arsip & Backup Data DTSEN</h1>
    <p class="lead opacity-75">Backup otomatis dari Firebase Firestore (koleksi: wilayah_desa)</p>
    <div class="mt-4">
      <button id="btnCreateBackup" class="btn btn-success btn-lg btn-backup mr-2">
        <i class="fas fa-database mr-2"></i> Buat Backup Baru
      </button>
      <button id="btnRefresh" class="btn btn-light btn-lg btn-backup">
        <i class="fas fa-sync-alt mr-2"></i> Refresh Arsip
      </button>
    </div>
  </div>
</section>

<main class="container py-4">
  <!-- Statistik Backup -->
  <div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-white border-0 shadow-sm p-3">
        <div class="d-flex align-items-center">
          <div class="icon-box bg-primary bg-opacity-10 mr-3">
            <i class="fas fa-folder-open text-primary"></i>
          </div>
          <div>
            <h6 class="text-muted mb-0">Total Arsip</h6>
            <h3 class="font-weight-bold mb-0" id="totalArsip">0</h3>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-white border-0 shadow-sm p-3">
        <div class="d-flex align-items-center">
          <div class="icon-box bg-success bg-opacity-10 mr-3">
            <i class="fas fa-check-circle text-success"></i>
          </div>
          <div>
            <h6 class="text-muted mb-0">Total Desa</h6>
            <h3 class="font-weight-bold mb-0" id="totalDesa">0</h3>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-white border-0 shadow-sm p-3">
        <div class="d-flex align-items-center">
          <div class="icon-box bg-info bg-opacity-10 mr-3">
            <i class="fas fa-users text-info"></i>
          </div>
          <div>
            <h6 class="text-muted mb-0">Total KK</h6>
            <h3 class="font-weight-bold mb-0" id="totalKK">0</h3>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
      <div class="card bg-white border-0 shadow-sm p-3">
        <div class="d-flex align-items-center">
          <div class="icon-box bg-warning bg-opacity-10 mr-3">
            <i class="fas fa-clock text-warning"></i>
          </div>
          <div>
            <h6 class="text-muted mb-0">Backup Terakhir</h6>
            <h6 class="font-weight-bold mb-0" id="lastBackup">-</h6>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Progress Backup (Hidden by default) -->
  <div id="backupProgress" class="card mb-4 border-0 shadow" style="display: none;">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0 font-weight-bold">Membuat Backup...</h6>
        <span id="progressPercent">0%</span>
      </div>
      <div class="progress-custom">
        <div id="progressBar" class="progress-bar-custom" style="width: 0%;"></div>
      </div>
      <p class="small text-muted mt-2" id="progressStatus">Menyiapkan data...</p>
    </div>
  </div>

  <!-- Daftar Arsip -->
  <div class="d-flex justify-content-between align-items-center mb-4 px-2">
    <h4 class="font-weight-bold mb-0">üìÅ Riwayat Backup Data</h4>
    <div>
      <span class="text-muted small mr-3">
        <i class="fas fa-hdd mr-1"></i> LocalStorage
      </span>
      <a href="index.html" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
        <i class="fas fa-arrow-left mr-1"></i> Kembali
      </a>
    </div>
  </div>

  <div class="row" id="archiveContainer">
    <div class="col-12 text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="sr-only">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Memuat daftar arsip backup...</p>
    </div>
  </div>
</main>

<!-- Modal Konfirmasi Hapus -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Hapus Arsip</h5>
        <button type="button" class="close" data-dismiss="modal">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Yakin ingin menghapus arsip <span id="deleteFileName" class="font-weight-bold"></span>?</p>
        <p class="small text-danger">Data yang dihapus tidak dapat dikembalikan.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Batal</button>
        <button type="button" id="confirmDelete" class="btn btn-danger">Hapus</button>
      </div>
    </div>
  </div>
</div>

<footer class="py-5 mt-5">
  <div class="container text-center">
    <p class="mb-1 text-white fw-bold small">DARI DATA KE AKSI</p>
    <small>¬© 2026 TKSK Sumber & Forum Puskesos Kecamatan Sumber</small>
    <br>
    <small class="text-muted">Backup disimpan di LocalStorage browser. Export ke CSV untuk penyimpanan permanen.</small>
  </div>
</footer>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
  // ============================================================
  // FIREBASE INITIALIZATION - Backup System
  // ============================================================
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { 
    getFirestore, 
    collection, 
    getDocs 
  } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

  // Konfigurasi Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAhQvRHBYX7dGW7QiSVN24cukmYHrN6d1c",
    authDomain: "data-ke-aksi-auth.firebaseapp.com",
    projectId: "data-ke-aksi-auth",
    storageBucket: "data-ke-aksi-auth.firebasestorage.app",
    messagingSenderId: "631382692174",
    appId: "1:631382692174:web:c10a099fb3021849eace1f"
  };

  // Inisialisasi Firebase
  let app, db;
  try {
    app = initializeApp(firebaseConfig);
    db = getFirestore(app);
    console.log('‚úÖ Firebase connected for backup');
  } catch (e) {
    console.error('‚ùå Firebase init error:', e);
  }

  // ============================================================
  // GLOBAL VARIABLES
  // ============================================================
  const STORAGE_KEY = 'dtsen_archives';
  let archives = [];
  let isConnected = false;
  let wilayahData = [];

  // DOM Elements
  const statusDot = document.getElementById('statusDot');
  const statusText = document.getElementById('statusText');
  const dataCount = document.getElementById('dataCount');
  const btnCreateBackup = document.getElementById('btnCreateBackup');
  const btnRefresh = document.getElementById('btnRefresh');
  const archiveContainer = document.getElementById('archiveContainer');
  const backupProgress = document.getElementById('backupProgress');
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');
  const progressStatus = document.getElementById('progressStatus');
  const totalArsip = document.getElementById('totalArsip');
  const totalDesa = document.getElementById('totalDesa');
  const totalKK = document.getElementById('totalKK');
  const lastBackup = document.getElementById('lastBackup');

  // ============================================================
  // UTILITY FUNCTIONS
  // ============================================================
  
  // Format angka
  function formatNumber(num) {
    return new Intl.NumberFormat('id-ID').format(num || 0);
  }

  // Format tanggal
  function formatDate(date) {
    const d = new Date(date);
    const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
    return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
  }

  // Format ukuran file
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  // Update status koneksi
  function updateConnectionStatus(connected) {
    isConnected = connected;
    if (connected) {
      statusDot.className = 'status-dot online';
      statusText.textContent = 'Terhubung ke Firebase';
    } else {
      statusDot.className = 'status-dot offline';
      statusText.textContent = 'Offline - Menggunakan cache';
    }
  }

  // Update progress backup
  function updateProgress(percent, status) {
    if (backupProgress) backupProgress.style.display = 'block';
    if (progressBar) progressBar.style.width = percent + '%';
    if (progressPercent) progressPercent.textContent = percent + '%';
    if (progressStatus) progressStatus.textContent = status;
    
    if (percent >= 100) {
      setTimeout(() => {
        backupProgress.style.display = 'none';
        progressBar.style.width = '0%';
      }, 2000);
    }
  }

  // ============================================================
  // LOAD DATA FROM FIREBASE
  // ============================================================
  async function loadFirebaseData() {
    try {
      updateConnectionStatus(true);
      statusDot.className = 'status-dot backup';
      statusText.textContent = 'Mengambil data...';
      
      const querySnapshot = await getDocs(collection(db, "wilayah_desa"));
      const data = [];
      
      querySnapshot.forEach((doc) => {
        const docData = doc.data();
        let desilArray = docData.desil || [];
        
        // Bersihkan data desil
        if (!Array.isArray(desilArray)) {
          if (desilArray && typeof desilArray === 'object') {
            desilArray = Object.values(desilArray);
          } else {
            desilArray = Array(10).fill(0);
          }
        }
        while (desilArray.length < 10) desilArray.push(0);
        
        // Hitung total KK
        const totalKK = desilArray.reduce((a, b) => (a || 0) + (b || 0), 0);
        
        data.push({
          id: doc.id,
          nama_wilayah: docData.nama_wilayah || docData.nama || doc.id,
          kecamatan: 'Sumber',
          desil: desilArray,
          total_kk: totalKK,
          d1: desilArray[0] || 0,
          d2: desilArray[1] || 0,
          d3: desilArray[2] || 0,
          d4: desilArray[3] || 0,
          d5_10: desilArray.slice(4).reduce((a, b) => (a || 0) + (b || 0), 0),
          timestamp: new Date().toISOString(),
          layanan: docData.layanan || { dtks: 0, sktm: 0, pengaduan: 0 }
        });
      });
      
      wilayahData = data.filter(item => item.nama_wilayah && item.total_kk > 0);
      
      // Update statistik
      if (totalDesa) totalDesa.textContent = wilayahData.length;
      if (totalKK) totalKK.textContent = formatNumber(wilayahData.reduce((sum, i) => sum + i.total_kk, 0));
      if (dataCount) dataCount.innerHTML = `<i class="fas fa-database mr-1"></i> ${wilayahData.length} desa`;
      
      updateConnectionStatus(true);
      return wilayahData;
      
    } catch (error) {
      console.error('Error loading Firebase:', error);
      updateConnectionStatus(false);
      return [];
    }
  }

  // ============================================================
  // CONVERT TO CSV
  // ============================================================
  function convertToCSV(data) {
    // Header CSV
    const headers = [
      'ID', 'Desa/Kelurahan', 'Kecamatan', 'Total KK',
      'Desil 1', 'Desil 2', 'Desil 3', 'Desil 4', 'Desil 5-10',
      'D1', 'D2', 'D3', 'D4', 'D5', 'D6', 'D7', 'D8', 'D9', 'D10',
      'DTKS', 'SKTM', 'Pengaduan', 'Timestamp Backup'
    ];
    
    let csv = headers.join(',') + '\n';
    
    data.forEach(item => {
      const row = [
        `"${item.id}"`,
        `"${item.nama_wilayah}"`,
        `"${item.kecamatan}"`,
        item.total_kk,
        item.d1,
        item.d2,
        item.d3,
        item.d4,
        item.d5_10,
        ...item.desil.slice(0, 10), // D1-D10 lengkap
        item.layanan?.dtks || 0,
        item.layanan?.sktm || 0,
        item.layanan?.pengaduan || 0,
        `"${new Date().toLocaleString('id-ID')}"`
      ];
      csv += row.join(',') + '\n';
    });
    
    return csv;
  }

  // ============================================================
  // ARCHIVE MANAGEMENT (LocalStorage)
  // ============================================================
  
  // Load archives dari localStorage
  function loadArchives() {
    const stored = localStorage.getItem(STORAGE_KEY);
    if (stored) {
      try {
        archives = JSON.parse(stored);
        // Sort by date descending
        archives.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      } catch (e) {
        archives = [];
      }
    } else {
      archives = [];
    }
    
    // Update UI
    if (totalArsip) totalArsip.textContent = archives.length;
    if (archives.length > 0 && lastBackup) {
      lastBackup.textContent = formatDate(archives[0].timestamp);
    }
    
    renderArchives();
    return archives;
  }

  // Save archive ke localStorage
  function saveArchive(archiveData) {
    archives.unshift(archiveData); // Tambah di awal
    localStorage.setItem(STORAGE_KEY, JSON.stringify(archives));
    
    // Update statistik
    if (totalArsip) totalArsip.textContent = archives.length;
    if (lastBackup) lastBackup.textContent = formatDate(archiveData.timestamp);
    
    renderArchives();
    return archives;
  }

  // Delete archive
  function deleteArchive(filename) {
    archives = archives.filter(a => a.filename !== filename);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(archives));
    
    if (totalArsip) totalArsip.textContent = archives.length;
    if (archives.length > 0 && lastBackup) {
      lastBackup.textContent = formatDate(archives[0].timestamp);
    } else {
      if (lastBackup) lastBackup.textContent = '-';
    }
    
    renderArchives();
  }

  // ============================================================
  // CREATE NEW BACKUP
  // ============================================================
  async function createBackup() {
    try {
      // 1. Load data dari Firebase
      updateProgress(10, 'Mengambil data dari Firebase...');
      const data = await loadFirebaseData();
      
      if (data.length === 0) {
        alert('Tidak ada data untuk di-backup!');
        updateProgress(0, '');
        backupProgress.style.display = 'none';
        return;
      }
      
      updateProgress(40, 'Memformat data ke CSV...');
      
      // 2. Convert ke CSV
      const csv = convertToCSV(data);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      
      updateProgress(70, 'Menyimpan arsip...');
      
      // 3. Buat metadata archive
      const timestamp = new Date();
      const period = `${timestamp.getFullYear()}-${(timestamp.getMonth()+1).toString().padStart(2,'0')}`;
      const filename = `dtsen_backup_${period}_${timestamp.getTime()}.csv`;
      
      const archiveData = {
        id: 'backup_' + timestamp.getTime(),
        filename: filename,
        periode: period,
        keterangan: `Backup DTSEN - ${wilayahData.length} desa, ${formatNumber(wilayahData.reduce((s,i)=>s+i.total_kk,0))} KK`,
        timestamp: timestamp.toISOString(),
        size: blob.size,
        fileSize: formatFileSize(blob.size),
        totalDesa: wilayahData.length,
        totalKK: wilayahData.reduce((s,i)=>s+i.total_kk, 0)
      };
      
      // 4. Simpan ke localStorage
      saveArchive(archiveData);
      
      updateProgress(90, 'Menyiapkan download...');
      
      // 5. Download CSV
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      updateProgress(100, 'Backup selesai!');
      
      // 6. Update status
      statusDot.className = 'status-dot online';
      
    } catch (error) {
      console.error('Backup error:', error);
      alert('Gagal membuat backup: ' + error.message);
      updateProgress(0, '');
      backupProgress.style.display = 'none';
    }
  }

  // ============================================================
  // RENDER ARCHIVES
  // ============================================================
  function renderArchives() {
    if (!archiveContainer) return;
    
    if (archives.length === 0) {
      archiveContainer.innerHTML = `
        <div class="col-12">
          <div class="alert alert-light text-center border py-5">
            <i class="fas fa-folder-open fa-4x text-muted mb-3"></i>
            <h5 class="text-muted">Belum Ada Backup</h5>
            <p class="text-muted mb-3">Klik tombol "Buat Backup Baru" untuk menyimpan data dari Firebase.</p>
            <button onclick="document.getElementById('btnCreateBackup').click()" class="btn btn-primary">
              <i class="fas fa-database mr-2"></i>Buat Backup Sekarang
            </button>
          </div>
        </div>
      `;
      return;
    }
    
    let html = '';
    archives.forEach((item, index) => {
      html += `
        <div class="col-md-6 mb-4">
          <div class="card card-archive shadow-sm p-2">
            <div class="card-body d-flex align-items-center">
              <div class="icon-box mr-3">
                <i class="fas fa-file-csv"></i>
              </div>
              <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                  <h5 class="mb-0 font-weight-bold text-dark">${item.periode}</h5>
                  <small class="text-muted">${item.fileSize || formatFileSize(item.size || 0)}</small>
                </div>
                <p class="mb-0 small text-muted">${item.keterangan}</p>
                <small class="text-info">
                  <i class="fas fa-calendar-alt mr-1"></i>${formatDate(item.timestamp)}
                </small>
              </div>
              <div class="ml-3">
                <div class="dropdown">
                  <button class="btn btn-light btn-sm rounded-circle" type="button" data-toggle="dropdown">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="#" onclick="downloadCSV('${item.filename}', '${item.periode}')">
                      <i class="fas fa-download text-success mr-2"></i>Download CSV
                    </a>
                    <a class="dropdown-item" href="#" onclick="previewArchive('${item.filename}')">
                      <i class="fas fa-eye text-primary mr-2"></i>Preview
                    </a>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item text-danger" href="#" onclick="showDeleteModal('${item.filename}')">
                      <i class="fas fa-trash mr-2"></i>Hapus
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    });
    
    archiveContainer.innerHTML = html;
  }

  // ============================================================
  // DOWNLOAD & PREVIEW FUNCTIONS
  // ============================================================
  
  // Download existing CSV (simulasi)
  window.downloadCSV = function(filename, periode) {
    // Cari archive berdasarkan filename
    const archive = archives.find(a => a.filename === filename);
    
    if (archive) {
      // Buat CSV dummy dengan metadata
      const dummyCSV = `# Backup DTSEN - ${archive.periode}\n` +
                      `# Tanggal: ${formatDate(archive.timestamp)}\n` +
                      `# Total Desa: ${archive.totalDesa || 0}\n` +
                      `# Total KK: ${formatNumber(archive.totalKK || 0)}\n` +
                      `# File ini adalah metadata backup. Data lengkap tersedia di LocalStorage.\n\n` +
                      `Untuk mengunduh data lengkap, buat backup baru atau gunakan fitur Export.`;
      
      const blob = new Blob([dummyCSV], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    } else {
      // Fallback: buat file baru
      loadFirebaseData().then(data => {
        const csv = convertToCSV(data);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      });
    }
  };

  // Preview archive
  window.previewArchive = function(filename) {
    const archive = archives.find(a => a.filename === filename);
    if (archive) {
      alert(`üìÅ ${archive.periode}\n\n` +
            `${archive.keterangan}\n\n` +
            `üìÖ ${formatDate(archive.timestamp)}\n` +
            `üíæ ${archive.fileSize || formatFileSize(archive.size || 0)}\n\n` +
            `Data lengkap tersedia di LocalStorage.`);
    }
  };

  // Delete modal
  window.showDeleteModal = function(filename) {
    const deleteFileName = document.getElementById('deleteFileName');
    if (deleteFileName) deleteFileName.textContent = filename;
    
    const confirmBtn = document.getElementById('confirmDelete');
    if (confirmBtn) {
      confirmBtn.onclick = function() {
        deleteArchive(filename);
        $('#deleteModal').modal('hide');
      };
    }
    
    $('#deleteModal').modal('show');
  };

  // ============================================================
  // INITIALIZATION
  // ============================================================
  
  // Load navbar
  fetch('navbar.html')
    .then(r => r.text())
    .then(html => document.getElementById('navbar').innerHTML = html)
    .catch(() => {});

  // Event listeners
  if (btnCreateBackup) {
    btnCreateBackup.addEventListener('click', createBackup);
  }
  
  if (btnRefresh) {
    btnRefresh.addEventListener('click', function() {
      loadFirebaseData().then(() => {
        loadArchives();
      });
    });
  }

  // Initial load
  loadFirebaseData().then(() => {
    loadArchives();
  });

  // Online/offline detection
  window.addEventListener('online', () => updateConnectionStatus(true));
  window.addEventListener('offline', () => updateConnectionStatus(false));
  updateConnectionStatus(navigator.onLine);

  // Export functions to global
  window.createBackup = createBackup;
  window.loadArchives = loadArchives;

</script>

<!-- Fallback untuk non-module browsers -->
<script nomodule>
  document.getElementById('archiveContainer').innerHTML = `
    <div class="col-12">
      <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        Browser Anda tidak mendukung fitur modern. Silakan gunakan Chrome, Firefox, atau Edge terbaru.
      </div>
    </div>
  `;
</script>

</body>
</html>
